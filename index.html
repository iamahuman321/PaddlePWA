
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Padel Management</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="icon" href="/icon-48.png">
  
  <!-- PWA Meta Tags -->
  <meta name="application-name" content="Padel Tournament Manager">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="PadelTM">
  <meta name="format-detection" content="telephone=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="msapplication-config" content="/browserconfig.xml">
  <meta name="msapplication-TileColor" content="#6A26CD">
  <meta name="msapplication-tap-highlight" content="no">
  <meta name="theme-color" content="#6A26CD">
  
  <!-- Apple Touch Icon -->
  <link rel="apple-touch-icon" href="/icon-180.png">
  
  <!-- Manifest -->
  <link rel="manifest" href="/manifest.json">
  
  <!-- Preconnect -->
  <link rel="preconnect" href="https://www.gstatic.com">
  <link rel="preconnect" href="https://cdnjs.cloudflare.com">
  <style>
    :root {
      --primary-color: #6A26CD; /* Vibrant purple for headers */
      --accent-color: #FCD34D; /* Yellow for buttons */
      --light-bg-color: #F8F9FA;
      --card-bg-color: #FFFFFF;
      --border-color: #E5E7EB;
      --text-color: #1F2937;
      --text-light: #6B7280;
      --success-color: #10B981;
      --danger-color: #EF4444;
      --gradient-start: #6A26CD;
      --gradient-end: #9254DE;
      --shadow-color: rgba(106, 38, 205, 0.15);
      
      /* Dark mode variables */
      --dark-bg-color: #121212;
      --dark-card-bg-color: #1E1E1E;
      --dark-border-color: #2D2D2D;
      --dark-text-color: #F0F0F0;
      --dark-text-light: #CCCCCC;
      --dark-header-color: #7E3AD7; /* Brighter purple for dark mode headers */
      --dark-accent-color: #FFD54F; /* Brighter yellow for dark mode */
      --dark-gradient-start: #4A148C;
      --dark-gradient-end: #7E57C2;
      --dark-shadow-color: rgba(126, 58, 215, 0.3);
    }
    
    body.dark-mode {
      background-color: var(--dark-bg-color);
      color: var(--dark-text-color);
    }
    
    body.dark-mode input::placeholder,
    body.dark-mode textarea::placeholder,
    body.dark-mode select::placeholder {
      color: #777777;
      opacity: 0.8;
    }
    
    body.dark-mode .app-header {
      background-color: var(--dark-header-color);
    }
    
    body.dark-mode .card {
      background-color: var(--dark-card-bg-color);
      border: 1px solid var(--dark-border-color);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    
    body.dark-mode .tournament-item {
      background-color: var(--dark-card-bg-color);
      border: 1px solid var(--dark-border-color);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    
    body.dark-mode .match-card {
      background-color: var(--dark-card-bg-color);
      border: 1px solid var(--dark-border-color);
    }
    
    body.dark-mode .bottom-nav {
      background-color: var(--dark-card-bg-color);
      border-top: 1px solid var(--dark-border-color);
    }
    
    body.dark-mode .nav-item {
      color: var(--dark-text-light);
    }
    
    body.dark-mode .sidebar {
      background-color: var(--dark-card-bg-color);
      border-right: 1px solid var(--dark-border-color);
    }
    
    body.dark-mode .form-control {
      background-color: var(--dark-card-bg-color);
      border: 1px solid var(--dark-border-color);
      color: var(--dark-text-color);
    }
    
    body.dark-mode .form-control:focus {
      border-color: var(--primary-color);
      outline: none;
      box-shadow: 0 0 0 2px rgba(142, 68, 173, 0.3);
    }
    
    body.dark-mode .form-control::placeholder {
      color: #999999;
      opacity: 0.9;
    }
    
    body.dark-mode .score-input::placeholder {
      color: #999999;
      opacity: 0.9;
    }
    
    body.dark-mode .btn {
      background-color: var(--dark-accent-color);
      color: var(--dark-bg-color);
      border: 1px solid var(--dark-border-color);
    }
    
    body.dark-mode .btn:hover {
      background-color: #D4A017;
    }
    
    body.dark-mode .btn-primary {
      background-color: var(--primary-color);
      color: white;
    }
    
    body.dark-mode .btn-danger {
      background-color: var(--danger-color);
      color: white;
    }
    
    body.dark-mode .btn-success {
      background-color: var(--success-color);
      color: white;
    }
    
    body.dark-mode .settings-title {
      border-bottom-color: var(--dark-border-color);
      color: var(--dark-text-color) !important;
    }
    
    body.dark-mode .settings-option {
      border-bottom-color: var(--dark-border-color);
    }
    
    body.dark-mode .settings-option-label {
      color: var(--dark-text-color) !important;
    }
    
    body.dark-mode .about-link {
      color: var(--primary-color);
    }
    
    body.dark-mode .about-section {
      background-color: var(--dark-card-bg-color);
      border: 1px solid var(--dark-border-color);
    }
    
    body.dark-mode .slider {
      background-color: #444;
    }
    
    body.dark-mode input:checked + .slider {
      background-color: var(--primary-color);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      -webkit-tap-highlight-color: transparent;
      outline: none;
    }

    body {
      background-color: var(--light-bg-color);
      color: var(--text-color);
      min-height: 100vh;
      position: relative;
      padding-bottom: 40px; /* Reduced space for smaller bottom navigation */
      scroll-behavior: auto; /* Disable smooth scrolling */
      overscroll-behavior: none; /* Prevent bounce effects */
      -webkit-overflow-scrolling: auto; /* Disable momentum scrolling */
      touch-action: pan-y; /* Allow only vertical scrolling */
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      overflow-x: hidden;
    }
    
    /* Enable text selection for input fields and content areas */
    input, textarea, .form-control, p, h1, h2, h3, h4, h5, h6, span {
      -webkit-user-select: text;
      -khtml-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
    }

    /* PIN Popup Modal Styles */
    .pin-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.6);
      z-index: 999;
      display: none;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .pin-modal.active {
      display: flex;
      opacity: 1;
    }
    
    .pin-modal-content {
      background-color: var(--card-bg-color);
      padding: 2rem;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      text-align: center;
      max-width: 320px;
      width: 90%;
      transform: scale(0.9);
      transition: transform 0.3s ease;
    }
    
    .pin-modal.active .pin-modal-content {
      transform: scale(1);
    }
    
    body.dark-mode .pin-modal-content {
      background-color: var(--dark-card-bg-color);
      color: var(--dark-text-color);
    }
    
    .pin-title {
      font-size: 1.3rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
      color: var(--text-color);
    }
    
    body.dark-mode .pin-title {
      color: var(--dark-text-color);
    }
    
    .pin-subtitle {
      font-size: 0.9rem;
      color: var(--text-light);
      margin-bottom: 1.5rem;
    }
    
    body.dark-mode .pin-subtitle {
      color: var(--dark-text-light);
    }
    
    .pin-input {
      width: 100%;
      padding: 1rem;
      font-size: 1.2rem;
      text-align: center;
      border: 2px solid var(--border-color);
      border-radius: 12px;
      margin-bottom: 1.5rem;
      background-color: var(--light-bg-color);
      letter-spacing: 0.3em;
      font-family: monospace;
    }
    
    .pin-input:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(106, 38, 205, 0.1);
      outline: none;
    }
    
    body.dark-mode .pin-input {
      background-color: var(--dark-bg-color);
      border-color: var(--dark-border-color);
      color: var(--dark-text-color);
    }
    
    body.dark-mode .pin-input:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(126, 58, 215, 0.2);
    }
    
    .pin-buttons {
      display: flex;
      gap: 1rem;
    }
    
    .pin-btn {
      flex: 1;
      padding: 0.8rem;
      border: none;
      border-radius: 10px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
      touch-action: manipulation;
    }
    
    .pin-btn.cancel {
      background-color: var(--border-color);
      color: var(--text-color);
    }
    
    .pin-btn.cancel:hover {
      background-color: #D1D5DB;
    }
    
    .pin-btn.confirm {
      background-color: var(--danger-color);
      color: white;
    }
    
    .pin-btn.confirm:hover {
      background-color: #DC2626;
    }
    
    body.dark-mode .pin-btn.cancel {
      background-color: var(--dark-border-color);
      color: var(--dark-text-color);
    }
    
    body.dark-mode .pin-btn.cancel:hover {
      background-color: #404040;
    }

    /* Header Styles */
    .app-header {
      background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
      color: white;
      padding: 0.5rem;
      padding-top: max(0.5rem, env(safe-area-inset-top));
      text-align: center;
      font-weight: bold;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 200;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px var(--shadow-color);
      min-height: 50px;
      max-height: 50px;
    }
    
    body.dark-mode .app-header {
      background: linear-gradient(135deg, var(--dark-gradient-start), var(--dark-gradient-end));
      box-shadow: 0 2px 8px var(--dark-shadow-color);
    }

    .header-title {
      flex: 1;
      text-align: center;
      font-size: 1rem;
      letter-spacing: 0.3px;
    }

    .header-action {
      background: none;
      border: none;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
      padding: 0.6rem;
      transition: transform 0.2s ease;
      min-height: 40px;
      min-width: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    
    .header-action:hover {
      transform: scale(1.1);
    }

    /* Screen Layout - Fixed positioning */
    .screen {
      display: none;
      opacity: 0;
      transform: none;
      transition: opacity 0.3s ease;
      position: fixed;
      top: 50px; /* Always below header */
      left: 0;
      right: 0;
      bottom: 60px; /* Always above bottom nav */
      background-color: var(--light-bg-color);
      z-index: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding-top: 1rem; /* Consistent top spacing */
      padding-bottom: 1rem; /* Consistent bottom spacing */
    }
    
    body.dark-mode .screen {
      background-color: var(--dark-bg-color);
    }
    
    .screen.active {
      display: block;
      opacity: 1;
      transform: none;
      z-index: 10;
    }

    /* Container Styles - Mobile Optimized */
    .container {
      padding: 0 1.2rem;
      max-width: 100%;
      margin: 0 auto;
      width: 100%;
      box-sizing: border-box;
    }
    
    @media (min-width: 768px) {
      .container {
        max-width: 600px;
        padding: 0 1.5rem;
      }
    }

    /* Card Styles - Mobile Optimized */
    .card {
      background-color: var(--card-bg-color);
      border-radius: 18px;
      box-shadow: 0 6px 18px var(--shadow-color);
      padding: 1.6rem;
      margin-bottom: 1.5rem;
      transition: all 0.25s ease;
      border: 1px solid var(--border-color);
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      position: relative;
      overflow: hidden;
    }
    
    .card:hover {
      box-shadow: 0 4px 8px var(--shadow-color);
    }

    .card:active {
      background-color: #FAFAFA;
      box-shadow: 0 2px 6px var(--shadow-color);
    }
    
    body.dark-mode .card {
      background-color: var(--dark-card-bg-color);
      border: 1px solid var(--dark-border-color);
      box-shadow: 0 6px 16px var(--dark-shadow-color);
    }
    
    body.dark-mode .card:hover {
      box-shadow: 0 8px 20px var(--dark-shadow-color);
    }

    /* Button Styles - Mobile Optimized */
    .btn {
      background-color: var(--accent-color);
      color: var(--text-color);
      border: none;
      border-radius: 12px;
      padding: 1.2rem 2rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-block;
      text-align: center;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      text-decoration: none;
      box-shadow: 0 4px 12px rgba(252, 211, 77, 0.3);
      font-size: 1.1rem;
      min-height: 52px; /* Larger touch target for mobile */
      min-width: 52px;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      position: relative;
      overflow: hidden;
    }

    .btn:hover {
      background-color: #F59E0B;
      box-shadow: 0 2px 6px rgba(252, 211, 77, 0.25);
    }
    
    .btn:active {
      background-color: #E59000; /* Slightly darker when pressed */
      box-shadow: 0 1px 3px rgba(252, 211, 77, 0.2);
    }

    .btn-block {
      display: block;
      width: 100%;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
      color: white;
      box-shadow: 0 4px 10px var(--shadow-color);
    }
    
    .btn-primary:hover {
      background: linear-gradient(135deg, var(--gradient-end), var(--gradient-start));
      box-shadow: 0 6px 12px var(--shadow-color);
    }
    
    body.dark-mode .btn-primary {
      background: linear-gradient(135deg, var(--dark-gradient-start), var(--dark-gradient-end));
      box-shadow: 0 4px 10px var(--dark-shadow-color);
    }
    
    body.dark-mode .btn-primary:hover {
      background: linear-gradient(135deg, var(--dark-gradient-end), var(--dark-gradient-start));
      box-shadow: 0 6px 12px var(--dark-shadow-color);
    }

    .btn-danger {
      background-color: var(--danger-color);
      color: white;
      box-shadow: 0 4px 6px rgba(239, 68, 68, 0.25);
    }
    
    .btn-danger:hover {
      background-color: #DC2626;
      box-shadow: 0 6px 8px rgba(239, 68, 68, 0.35);
    }

    .btn-success {
      background-color: var(--success-color);
      color: white;
      box-shadow: 0 4px 6px rgba(16, 185, 129, 0.25);
    }
    
    .btn-success:hover {
      background-color: #059669;
      box-shadow: 0 6px 8px rgba(16, 185, 129, 0.35);
    }

    .btn-small {
      padding: 0.6rem 1.2rem;
      font-size: 0.8rem;
      min-height: 40px; /* Ensure touch target minimum */
      min-width: 40px;
    }
    
    .btn-tiny {
      padding: 0.4rem 0.8rem;
      font-size: 0.75rem;
      min-height: 36px;
      min-width: 36px;
    }
    
    .btn i {
      margin-right: 6px;
    }

    /* Form Styles - Mobile Optimized */
    .form-group {
      margin-bottom: 1.8rem;
    }

    .form-label {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
      font-weight: 600;
      font-size: 1.1rem;
      color: var(--text-color);
    }
    
    body.dark-mode .form-label {
      color: var(--dark-text-color);
    }
    
    .player-count-value, .range-label {
      color: var(--primary-color);
      font-weight: 600;
    }
    
    body.dark-mode .player-count-value, 
    body.dark-mode .range-label {
      color: var(--dark-header-color);
    }

    .form-control {
      width: 100%;
      padding: 1.4rem;
      border: 2px solid var(--border-color);
      border-radius: 16px;
      font-size: 1.2rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      background-color: #FFFFFF;
      color: var(--text-color);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
      min-height: 56px; /* Larger touch target for mobile */
      touch-action: manipulation;
      -webkit-appearance: none;
      user-select: text;
      position: relative;
    }
    
    .form-control:hover {
      border-color: #CCCCCC;
    }
    
    .form-control:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(106, 38, 205, 0.15);
    }
    
    .form-control::placeholder {
      color: #AAAAAA;
    }
    
    body.dark-mode .form-control {
      background-color: var(--dark-card-bg-color);
      border-color: var(--dark-border-color);
      color: var(--dark-text-color);
    }
    
    body.dark-mode .form-control::placeholder {
      color: #888888;
      opacity: 1;
    }
    
    body.dark-mode .form-control:hover {
      border-color: #3D3D3D;
    }
    
    body.dark-mode .form-control:focus {
      border-color: var(--dark-header-color);
      box-shadow: 0 0 0 3px rgba(126, 58, 215, 0.25);
    }
    
    body.dark-mode .form-control::placeholder {
      color: #666666;
    }
    
    input[type="range"] {
      height: 8px;
      -webkit-appearance: none;
      margin: 10px 0;
      background: #EEEEEE;
      border-radius: 4px;
      border: none;
    }
    
    input[type="range"]:focus {
      outline: none;
    }
    
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      height: 20px;
      width: 20px;
      border-radius: 50%;
      background: var(--primary-color);
      cursor: pointer;
      box-shadow: 0 0 0 3px rgba(106, 38, 205, 0.15);
    }
    
    input[type="range"]::-moz-range-thumb {
      height: 20px;
      width: 20px;
      border-radius: 50%;
      background: var(--primary-color);
      cursor: pointer;
      box-shadow: 0 0 0 3px rgba(106, 38, 205, 0.15);
      border: none;
    }
    
    body.dark-mode input[type="range"] {
      background: #333333;
    }
    
    body.dark-mode input[type="range"]::-webkit-slider-thumb {
      background: var(--dark-header-color);
      box-shadow: 0 0 0 3px rgba(126, 58, 215, 0.25);
    }
    
    body.dark-mode input[type="range"]::-moz-range-thumb {
      background: var(--dark-header-color);
      box-shadow: 0 0 0 3px rgba(126, 58, 215, 0.25);
    }

    /* Navigation Styles */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: white;
      display: none; /* Hidden by default, will be shown when needed */
      border-top: 1px solid var(--border-color);
      z-index: 100;
      padding-bottom: env(safe-area-inset-bottom); /* Handle iOS notch */
      min-height: 40px;
    }

    .nav-item {
      flex: 1;
      text-align: center;
      padding: 0.5rem 0.5rem;
      color: var(--text-light);
      text-decoration: none;
      font-size: 0.75rem;
      min-height: 36px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }

    .nav-item.active {
      color: var(--primary-color);
    }
    
    body.dark-mode .nav-item.active {
      color: var(--primary-color);
    }

    .nav-icon {
      display: block;
      font-size: 1.2rem;
      margin-bottom: 0.15rem;
    }

    /* Match Card Styles */
    .match-card {
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      background-color: white;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      scroll-snap-align: start;
      scroll-margin-top: 10px;
    }
    
    .match-card:hover {
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
      transform: translateY(-2px);
    }
    
    body.dark-mode .match-card {
      background-color: var(--dark-card-bg-color);
      border: 1px solid var(--dark-border-color);
      box-shadow: 0 4px 12px var(--dark-shadow-color);
    }
    
    body.dark-mode .match-card:hover {
      box-shadow: 0 6px 16px var(--dark-shadow-color);
    }

    .match-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 1rem;
      align-items: center;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    body.dark-mode .match-header {
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .match-title {
      font-weight: bold;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      color: var(--primary-color);
    }
    
    .match-title i {
      margin-right: 8px;
    }
    
    body.dark-mode .match-title {
      color: var(--dark-header-color);
    }
    
    .match-status {
      background-color: rgba(106, 38, 205, 0.1);
      color: var(--primary-color);
      font-size: 0.8rem;
      padding: 0.3rem 0.8rem;
      border-radius: 20px;
      font-weight: 500;
    }
    
    body.dark-mode .match-status {
      background-color: rgba(126, 58, 215, 0.2);
      color: var(--dark-header-color);
    }
    
    .match-status.completed {
      background-color: rgba(16, 185, 129, 0.1);
      color: var(--success-color);
    }

    .match-teams {
      display: flex;
      justify-content: space-between;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .match-team {
      flex: 1;
      padding: 1rem;
      text-align: center;
      border-radius: 12px;
      background-color: rgba(0, 0, 0, 0.02);
      border: 1px solid rgba(0, 0, 0, 0.05);
      transition: all 0.2s ease;
    }
    
    .match-team:hover {
      background-color: rgba(0, 0, 0, 0.03);
    }
    
    body.dark-mode .match-team {
      background-color: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    body.dark-mode .match-team:hover {
      background-color: rgba(255, 255, 255, 0.05);
    }
    
    .team-a {
      border-left: 4px solid var(--primary-color);
    }
    
    .team-b {
      border-left: 4px solid var(--accent-color);
    }

    .match-score {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1.5rem;
      margin-top: 1rem;
      background-color: rgba(0, 0, 0, 0.02);
      padding: 1rem;
      border-radius: 12px;
    }
    
    body.dark-mode .match-score {
      background-color: rgba(255, 255, 255, 0.03);
    }

    .score-input {
      width: 120px;
      text-align: center;
      font-weight: bold;
      padding: 1rem;
      border: 2px solid var(--border-color);
      border-radius: 12px;
      font-size: 1.6rem;
      background-color: var(--card-bg-color);
      color: var(--text-color);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      transition: all 0.2s ease;
      min-height: 48px;
      touch-action: manipulation;
      -webkit-appearance: none;
    }
    
    .score-input:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(106, 38, 205, 0.15);
      outline: none;
    }

    .score-display {
      font-size: 1.4rem;
      font-weight: bold;
      color: var(--text-light);
      min-width: 30px;
      text-align: center;
    }
    
    body.dark-mode .score-input {
      background-color: var(--dark-card-bg-color);
      border-color: var(--dark-border-color);
      color: var(--dark-text-color);
    }
    
    body.dark-mode .score-input::placeholder {
      color: #999999;
      opacity: 1;
    }
    
    body.dark-mode .score-display {
      color: var(--dark-text-light);
    }
    
    body.dark-mode .screen-title {
      color: var(--dark-text-color) !important;
    }
    
    body.dark-mode .empty-state h3 {
      color: var(--dark-text-color) !important;
    }
    
    body.dark-mode .empty-state p {
      color: var(--dark-text-light) !important;
    }
    
    body.dark-mode .team-name {
      color: var(--dark-text-color) !important;
    }
    
    body.dark-mode .team-players {
      color: var(--dark-text-light) !important;
    }
    
    body.dark-mode .match-title {
      color: var(--dark-header-color) !important;
    }

    /* Rest Card Styles */
    .rest-card {
      border: 2px dashed #FFB74D;
      border-radius: 16px;
      padding: 1.25rem;
      margin-bottom: 1.5rem;
      background-color: rgba(255, 183, 77, 0.1);
      text-align: center;
      position: relative;
      box-shadow: 0 4px 12px rgba(255, 183, 77, 0.15);
      scroll-snap-align: start;
      scroll-margin-top: 10px;
    }
    
    .rest-card:after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: repeating-linear-gradient(
        45deg,
        rgba(255, 183, 77, 0.05),
        rgba(255, 183, 77, 0.05) 10px,
        rgba(255, 183, 77, 0.1) 10px,
        rgba(255, 183, 77, 0.1) 20px
      );
      border-radius: 14px;
      z-index: 0;
      pointer-events: none;
    }

    .rest-player {
      font-weight: 600;
      color: #B45309;
      font-size: 1.1rem;
      position: relative;
      z-index: 1;
    }
    
    .rest-player i {
      color: #F59E0B;
      margin-right: 8px;
    }

    .rest-bonus {
      font-size: 0.95rem;
      color: #92400E;
      margin-top: 0.5rem;
      background-color: rgba(255, 255, 255, 0.5);
      padding: 0.5rem;
      border-radius: 8px;
      display: inline-block;
      font-weight: 500;
      position: relative;
      z-index: 1;
    }
    
    .rest-bonus i {
      color: #F59E0B;
      margin-right: 5px;
    }
    
    body.dark-mode .rest-card {
      background-color: rgba(255, 183, 77, 0.1);
      border-color: #B45309;
      box-shadow: 0 4px 12px rgba(255, 183, 77, 0.1);
    }
    
    body.dark-mode .rest-card:after {
      background: repeating-linear-gradient(
        45deg,
        rgba(255, 183, 77, 0.03),
        rgba(255, 183, 77, 0.03) 10px,
        rgba(255, 183, 77, 0.06) 10px,
        rgba(255, 183, 77, 0.06) 20px
      );
    }
    
    body.dark-mode .rest-player {
      color: #FFB74D;
    }
    
    body.dark-mode .rest-bonus {
      color: #FFB74D;
      background-color: rgba(0, 0, 0, 0.2);
    }

    /* Remove duplicate screen definition */
    
    /* Hide scrollbars */
    .screen::-webkit-scrollbar {
      display: none;
    }

    body.dark-mode .screen {
      background-color: var(--dark-bg-color);
    }

    .screen.active {
      display: block;
      opacity: 1;
      transform: none;
      z-index: 10;
    }
    
    /* Simple active state for touch */
    .active-touch {
      background-color: rgba(0, 0, 0, 0.05);
    }
    
    body.dark-mode .active-touch {
      background-color: rgba(255, 255, 255, 0.1);
    }

    /* Page container for better mobile layout */
    .page-container {
      position: relative;
      min-height: 100vh;
      overflow: hidden;
    }

    /* Tournament List Styles - Mobile Touch Optimized */
    .tournament-item {
      padding: 1.4rem;
      border-radius: 20px;
      margin-bottom: 1.2rem;
      background-color: #f8f9fa;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      touch-action: manipulation;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
      border: 1px solid rgba(0, 0, 0, 0.05);
      min-height: 60px;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      z-index: 10; /* Ensure it's above other elements */
    }

    .tournament-item:hover {
      background-color: #f5f5f5;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.06);
    }

    .tournament-item:active {
      background-color: #f0f0f0;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    }
    
    body.dark-mode .tournament-item {
      background-color: var(--dark-card-bg-color);
      border: 1px solid var(--dark-border-color);
      box-shadow: 0 4px 10px var(--dark-shadow-color);
    }
    
    body.dark-mode .tournament-name {
      color: var(--dark-text-color) !important;
    }
    
    body.dark-mode .tournament-item:hover {
      background-color: #222222;
      box-shadow: 0 6px 14px var(--dark-shadow-color);
    }

    /* Remove swipe-to-delete functionality as requested */

    .tournament-info {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.75rem;
    }

    .tournament-name {
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      color: var(--text-color);
      display: flex;
      align-items: center;
    }
    
    .tournament-name:before {
      content: '🏆';
      margin-right: 8px;
      font-size: 1.4rem;
    }
    
    body.dark-mode .tournament-name {
      color: var(--dark-text-color);
    }

    .tournament-meta {
      font-size: 0.85rem;
      color: var(--text-light);
      display: flex;
      justify-content: space-between;
      padding-top: 0.5rem;
      border-top: 1px solid rgba(0,0,0,0.05);
      gap: 0.75rem;
    }
    
    body.dark-mode .tournament-meta {
      color: var(--dark-text-light);
      border-top: 1px solid rgba(255,255,255,0.05);
    }
    
    .tournament-meta-item {
      display: flex;
      align-items: center;
    }
    
    .tournament-meta-item i {
      margin-right: 5px;
      opacity: 0.8;
    }

    .tournament-actions {
      display: none;
    }

    /* Leaderboard Styles */
    .leaderboard-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.25rem;
      border-bottom: 1px solid var(--border-color);
      transition: all 0.2s ease;
      min-height: 48px;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      scroll-snap-align: start;
      scroll-margin-top: 5px;
    }
    
    .leaderboard-item:hover {
      background-color: rgba(0, 0, 0, 0.02);
    }
    
    body.dark-mode .leaderboard-item {
      border-bottom-color: var(--dark-border-color);
    }
    
    body.dark-mode .leaderboard-item:hover {
      background-color: rgba(255, 255, 255, 0.03);
    }
    
    .leaderboard-item:first-child {
      background-color: rgba(106, 38, 205, 0.05);
      border-radius: 8px 8px 0 0;
      padding: 1.25rem 1rem;
    }
    
    .leaderboard-item:first-child .rank {
      color: var(--primary-color);
      font-size: 1.2rem;
    }
    
    .leaderboard-item:first-child .player-name {
      font-weight: 700;
    }
    
    .leaderboard-item:first-child .player-score {
      color: var(--primary-color);
      font-size: 1.2rem;
    }
    
    body.dark-mode .leaderboard-item:first-child {
      background-color: rgba(126, 58, 215, 0.1);
    }
    
    body.dark-mode .leaderboard-item:first-child .rank,
    body.dark-mode .leaderboard-item:first-child .player-score {
      color: var(--dark-header-color);
    }

    .rank {
      font-weight: bold;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: rgba(0, 0, 0, 0.05);
      border-radius: 50%;
      margin-right: 12px;
      color: var(--text-color);
      font-size: 1rem;
    }
    
    body.dark-mode .rank {
      background-color: rgba(255, 255, 255, 0.05);
      color: var(--dark-text-color);
    }
    
    .leaderboard-item:nth-child(2) .rank {
      background-color: rgba(192, 192, 192, 0.2);
      color: #555;
    }
    
    .leaderboard-item:nth-child(3) .rank {
      background-color: rgba(205, 127, 50, 0.2);
      color: #8B4513;
    }
    
    body.dark-mode .leaderboard-item:nth-child(2) .rank {
      background-color: rgba(192, 192, 192, 0.1);
      color: #BBB;
    }
    
    body.dark-mode .leaderboard-item:nth-child(3) .rank {
      background-color: rgba(205, 127, 50, 0.1);
      color: #CD7F32;
    }

    .player-name {
      flex: 1;
      cursor: pointer;
      padding: 0.5rem;
      font-weight: 500;
      color: var(--text-color);
      transition: all 0.2s ease;
      min-height: 44px;
      display: flex;
      align-items: center;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    
    .player-name:hover {
      color: var(--primary-color);
    }
    
    body.dark-mode .player-name {
      color: var(--dark-text-color);
    }
    
    body.dark-mode .player-name:hover {
      color: var(--dark-header-color);
    }

    .player-score {
      font-weight: bold;
      width: 60px;
      text-align: right;
      background-color: rgba(0, 0, 0, 0.03);
      padding: 0.5rem;
      border-radius: 8px;
    }
    
    body.dark-mode .player-score {
      background-color: rgba(255, 255, 255, 0.05);
    }
    
    body.dark-mode .rank {
      color: var(--dark-text-color);
      background-color: rgba(255, 255, 255, 0.1);
    }
    
    body.dark-mode .player-name {
      color: var(--dark-text-color) !important;
    }
    
    body.dark-mode .player-score {
      color: var(--dark-text-color);
      background-color: rgba(255, 255, 255, 0.08);
    }

    .screen-title {
      font-size: 1.5rem;
      margin-bottom: 1rem;
      font-weight: 700;
      color: var(--text-color);
      display: flex;
      align-items: center;
    }
    
    .screen-title i {
      margin-right: 10px;
      background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size: 1.3rem;
    }
    
    body.dark-mode .screen-title {
      color: var(--dark-text-color);
    }
    
    body.dark-mode .screen-title i {
      background: linear-gradient(135deg, var(--dark-gradient-start), var(--dark-gradient-end));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .center-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 80vh;
      text-align: center;
    }

    .courts-container {
      margin-bottom: 1rem;
    }

    .rounds-nav {
      display: flex;
      overflow-x: auto;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      align-items: center;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none; /* Firefox */
      padding: 0.5rem;
      scroll-padding: 0.5rem;
      gap: 0.5rem;
      scroll-behavior: smooth;
      overscroll-behavior-x: contain;
      scroll-snap-type: x proximity;
    }
    
    .rounds-nav::-webkit-scrollbar {
      display: none; /* Chrome, Safari, Edge */
    }
    
    .round-tab, .add-round-btn {
      scroll-snap-align: start;
    }

    .round-tab {
      padding: 0.6rem 1rem;
      background-color: #f5f5f5;
      border-radius: 25px;
      white-space: nowrap;
      cursor: pointer;
      color: var(--text-color);
      font-weight: 500;
      transition: all 0.2s ease;
      border: 1px solid rgba(0, 0, 0, 0.05);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.03);
      display: flex;
      align-items: center;
      min-height: 32px;
      font-size: 0.85rem;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    
    .round-tab:before {
      content: "🔄";
      margin-right: 4px;
      font-size: 0.8rem;
    }

    .round-tab.active {
      background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
      color: white;
      box-shadow: 0 2px 6px var(--shadow-color);
      border: 1px solid rgba(255, 255, 255, 0.1);
      transform: translateY(-1px);
    }
    
    .round-tab.active:before {
      content: "✓";
    }
    
    .round-tab:hover:not(.active) {
      background-color: #eeeeee;
      transform: translateY(-1px);
    }
    
    body.dark-mode .round-tab {
      background-color: var(--dark-border-color);
      color: var(--dark-text-color) !important;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    body.dark-mode .round-tab:hover:not(.active) {
      background-color: #2a2a2a;
    }
    
    body.dark-mode .round-tab.active {
      background: linear-gradient(135deg, var(--dark-gradient-start), var(--dark-gradient-end));
      color: white;
      box-shadow: 0 2px 6px var(--dark-shadow-color);
    }

    .add-round-btn {
      padding: 0.6rem 1rem;
      background-color: var(--success-color);
      color: white;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      white-space: nowrap;
      font-weight: 500;
      display: flex;
      align-items: center;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
      min-height: 32px;
      font-size: 0.85rem;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    
    .add-round-btn:hover {
      background-color: #059669;
      transform: translateY(-1px);
      box-shadow: 0 3px 6px rgba(16, 185, 129, 0.25);
    }
    
    .add-round-btn i {
      margin-right: 4px;
    }

    .loading {
      text-align: center;
      padding: 2rem;
    }

    .team-name {
      font-weight: bold;
      margin-bottom: 0.25rem;
    }

    .team-players {
      font-size: 0.875rem;
      color: var(--text-light);
    }
    
    body.dark-mode .team-name {
      color: var(--dark-text-color);
    }
    
    body.dark-mode .team-players {
      color: var(--dark-text-light);
    }

    .save-score-btn {
      margin-top: 1rem;
    }

    .new-tournament-logo {
      width: 150px;
      height: 150px;
      background-color: var(--primary-color);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 2rem;
    }

    .new-tournament-logo i {
      font-size: 4rem;
      color: white;
    }

    .export-section {
      padding-top: 1rem;
      border-top: 1px solid var(--border-color);
    }

    .export-buttons {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .player-count-range {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .player-count-display {
      font-weight: bold;
      min-width: 30px;
      text-align: center;
    }

    .rest-info {
      background-color: rgba(252, 211, 77, 0.15);
      padding: 1rem;
      border-radius: 12px;
      font-size: 0.95rem;
      margin-top: 0.75rem;
      color: #92400E;
      border: 1px solid rgba(252, 211, 77, 0.3);
      font-weight: 500;
      display: flex;
      align-items: center;
      box-shadow: 0 2px 4px rgba(252, 211, 77, 0.1);
    }
    
    .rest-info i {
      font-size: 1.2rem;
      color: #F59E0B;
      margin-right: 10px;
      flex-shrink: 0;
    }
    
    body.dark-mode .rest-info {
      background-color: rgba(59, 65, 81, 0.6);
      color: #F3F4F6;
      border-color: rgba(75, 85, 99, 0.4);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    body.dark-mode .rest-info i {
      color: #FBBF24;
    }

    /* Modal Styles */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .modal.active {
      display: flex;
      opacity: 1;
    }

    .modal-content {
      background-color: white;
      border-radius: 12px;
      padding: 2rem;
      max-width: 400px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      overscroll-behavior-y: contain;
      scroll-behavior: smooth;
      transform: scale(0.8);
      opacity: 0;
      transition: transform 0.3s ease, opacity 0.3s ease;
    }
    
    .modal.active .modal-content {
      transform: scale(1);
      opacity: 1;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
    }

    .empty-state {
      text-align: center;
      padding: 2rem;
      color: var(--text-light);
    }
    
    /* Sidebar Styles with enhanced animations */
    .sidebar {
      position: fixed;
      top: 0;
      left: -320px;
      width: 320px;
      height: 100vh;
      background-color: white;
      z-index: 2000;
      transition: left 0.3s ease;
      box-shadow: 2px 0 20px rgba(0, 0, 0, 0.15);
      display: flex;
      flex-direction: column;
    }
    
    .sidebar.active {
      left: 0;
    }
    
    .sidebar-header {
      padding: 1.25rem;
      background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .sidebar-title {
      font-weight: 600;
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      letter-spacing: 0.5px;
    }
    
    body.dark-mode .sidebar-header {
      background: linear-gradient(135deg, var(--dark-gradient-start), var(--dark-gradient-end));
    }
    
    body.dark-mode .sidebar-title {
      color: var(--dark-text-color);
    }
    
    .close-btn {
      background: none;
      border: none;
      color: white;
      font-size: 1.25rem;
      cursor: pointer;
      transition: transform 0.2s ease;
      height: 40px;
      width: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .close-btn:hover {
      background-color: rgba(255, 255, 255, 0.1);
      transform: scale(1.1);
    }
    
    body.dark-mode .close-btn {
      color: var(--dark-text-color);
    }
    
    body.dark-mode .close-btn:hover {
      background-color: rgba(0, 0, 0, 0.2);
    }
    
    .sidebar-content {
      padding: 0;
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      overscroll-behavior-y: contain;
      scroll-behavior: smooth;
      scrollbar-width: thin;
      -ms-overflow-style: none;
    }
    
    .sidebar-content::-webkit-scrollbar {
      width: 4px;
    }
    
    .sidebar-content::-webkit-scrollbar-thumb {
      background-color: rgba(0, 0, 0, 0.2);
      border-radius: 4px;
    }
    
    body.dark-mode .sidebar-content::-webkit-scrollbar-thumb {
      background-color: rgba(255, 255, 255, 0.2);
    }
    
    .sidebar-menu {
      list-style-type: none;
      padding: 1rem;
      margin: 0;
    }
    
    .sidebar-menu-item {
      padding: 1.25rem 1.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      border-radius: 12px;
      margin-bottom: 0.5rem;
      color: var(--text-color);
      transition: all 0.3s ease;
      font-weight: 500;
      min-height: 48px;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    
    body.dark-mode .sidebar-menu-item {
      color: var(--dark-text-color) !important;
    }
    
    .sidebar-menu-item i {
      margin-right: 1rem;
      font-size: 1.1rem;
      width: 20px;
      text-align: center;
      color: var(--primary-color);
      opacity: 0.8;
      transition: all 0.2s ease;
    }
    
    body.dark-mode .sidebar-menu-item i {
      color: var(--dark-header-color);
    }
    
    .sidebar-menu-item:hover {
      background-color: #f5f5f5;
      transform: translateX(5px);
    }
    
    .sidebar-menu-item:hover i {
      opacity: 1;
    }
    
    .sidebar-menu-item.active {
      background-color: rgba(106, 38, 205, 0.1);
      font-weight: 600;
    }
    
    .sidebar-menu-item.active i {
      opacity: 1;
    }
    
    body.dark-mode .sidebar-menu-item:hover {
      background-color: #2a2a2a;
    }
    
    body.dark-mode .sidebar-menu-item.active {
      background-color: rgba(126, 58, 215, 0.2);
      color: var(--dark-text-color);
    }
    
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1500;
      display: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .overlay.active {
      display: block;
      opacity: 1;
    }
    
    /* Settings Page Styles */
    .settings-section {
      margin-bottom: 2rem;
    }
    
    .settings-title {
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 1rem;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 0.5rem;
    }
    
    .settings-option {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.25rem 0;
      border-bottom: 1px solid var(--border-color);
      min-height: 48px;
    }
    
    .settings-option-label {
      display: flex;
      align-items: center;
    }
    
    .settings-option-label i {
      margin-right: 0.75rem;
      width: 1.5rem;
      text-align: center;
    }
    
    .switch {
      position: relative;
      display: inline-block;
      width: 48px;
      height: 24px;
    }
    
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }
    
    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .slider {
      background-color: var(--primary-color);
    }
    
    input:focus + .slider {
      box-shadow: 0 0 1px var(--primary-color);
    }
    
    input:checked + .slider:before {
      transform: translateX(24px);
    }
    
    .about-link {
      display: block;
      color: var(--primary-color);
      text-decoration: none;
      margin: 0.5rem 0;
    }
    
    .about-section {
      margin-top: 1rem;
      padding: 1.5rem;
      background-color: var(--light-bg-color);
      border-radius: 12px;
      font-size: 0.95rem;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      border: 1px solid var(--border-color);
    }
    
    body.dark-mode .about-section {
      background-color: var(--dark-card-bg-color);
      border-color: var(--dark-border-color);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    }
    
    .about-section h4 {
      margin-top: 0;
      margin-bottom: 0.75rem;
      color: var(--primary-color);
      font-size: 1.2rem;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 0.5rem;
    }
    
    body.dark-mode .about-section h4 {
      color: var(--primary-color);
      border-bottom-color: var(--dark-border-color);
    }
    
    .about-section ul {
      padding-left: 1.5rem;
      margin-bottom: 0;
    }
    
    .about-section ul li {
      margin-bottom: 0.4rem;
    }
    
    .about-section a {
      color: var(--primary-color);
      text-decoration: none;
      font-weight: 500;
    }
    
    .about-section a:hover {
      text-decoration: underline;
    }
    
    body.dark-mode .about-section a {
      color: var(--primary-color);
    }
  </style>
</head>
<body>
  <!-- Page wrapper for mobile app experience -->
  <div class="page-container">
  <!-- App Header -->
  <header class="app-header">
    <button id="backBtn" class="header-action" style="display: none;">
      <i class="fas fa-arrow-left"></i>
    </button>
    <div class="header-title">Padel Management</div>
    <button id="menuBtn" class="header-action">
      <i class="fas fa-bars"></i>
    </button>
  </header>
  
  <!-- Sidebar Menu -->
  <div id="sidebar" class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title">
        <i class="fas fa-table-tennis" style="margin-right: 8px;"></i> 
        Padel Management
      </div>
      <button id="closeSidebarBtn" class="close-btn">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="sidebar-content">
      <div style="padding: 1rem; text-align: center; margin-bottom: 1rem; border-bottom: 1px solid var(--border-color);">
        <div style="width: 60px; height: 60px; background-color: var(--primary-color); border-radius: 50%; margin: 0 auto 1rem; display: flex; justify-content: center; align-items: center;">
          <i class="fas fa-table-tennis" style="font-size: 1.8rem; color: white;"></i>
        </div>
        <h4 style="margin: 0; font-size: 1.2rem;">Padel Management</h4>
        <p style="margin: 0.25rem 0 0 0; font-size: 0.8rem; color: var(--text-light);">Tournament System</p>
      </div>
      <ul class="sidebar-menu">
        <li class="sidebar-menu-item active" data-page="tournaments">
          <i class="fas fa-trophy"></i> Tournaments
        </li>
        <li class="sidebar-menu-item" data-page="players">
          <i class="fas fa-users"></i> Players
        </li>
        <li class="sidebar-menu-item" data-page="rankings">
          <i class="fas fa-chart-bar"></i> Statistics
        </li>
        <li class="sidebar-menu-item" data-page="settings">
          <i class="fas fa-cog"></i> Settings
        </li>
      </ul>
    </div>
    <div style="padding: 1rem; margin-top: auto; border-top: 1px solid var(--border-color); text-align: center;">
      <p style="margin: 0; font-size: 0.8rem; color: var(--text-light);">v1.2.0 - © 2025 Padel Americano</p>
    </div>
  </div>
  
  <!-- Overlay for sidebar -->
  <div id="overlay" class="overlay"></div>
  
  <!-- PIN Modal -->
  <div id="pinModal" class="pin-modal">
    <div class="pin-modal-content">
      <h3 class="pin-title">Enter PIN</h3>
      <p class="pin-subtitle">Please enter your PIN to confirm this action</p>
      <input type="password" id="pinInput" class="pin-input" maxlength="4" placeholder="----">
      <div class="pin-buttons">
        <button class="pin-btn cancel" onclick="closePinModal()">Cancel</button>
        <button class="pin-btn confirm" onclick="confirmPinAction()">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Tournament List Screen -->
  <div id="tournamentListScreen" class="screen active">
    <div class="container">
      <div style="padding: 20px 0; text-align: center;">
        <div style="margin-bottom: 1rem;">
          <h1 style="font-size: 2.5rem; margin: 0; font-weight: bold; color: var(--primary-color);">PADEL</h1>
          <h1 style="font-size: 3rem; margin: 0; font-weight: 900; text-transform: uppercase; color: var(--primary-color);">MANAGEMENT</h1>
          <p style="color: var(--text-light); margin-top: 10px; font-size: 1rem; max-width: 80%; text-align: center; margin: 0.5rem auto;">Professional tournament management system</p>
        </div>
      </div>
      <div id="tournamentsList" style="margin-bottom: 80px; padding-bottom: 20px;">
        <!-- Tournament list will be populated here -->
        <div class="empty-state" style="text-align: center; padding: 2rem 1.5rem;">
          <div style="width: 80px; height: 80px; margin: 0 auto 1.5rem; background-color: #f0f0f0; border-radius: 50%; display: flex; justify-content: center; align-items: center;">
            <i class="fas fa-trophy" style="font-size: 2.5rem; color: var(--primary-color);"></i>
          </div>
          <h3 style="font-size: 1.4rem; margin-bottom: 1rem; color: var(--text-color);">No tournaments yet</h3>
          <p style="color: var(--text-light); margin-bottom: 1.5rem;">Create your first tournament to get started!</p>
        </div>
      </div>
      <div style="position: fixed; bottom: 20px; left: 0; right: 0; padding: 0 20px; z-index: 100;">
        <button id="newTournamentBtn" class="btn btn-primary btn-block" style="border-radius: 8px; padding: 15px; font-size: 1rem;">
          <i class="fas fa-plus" style="margin-right: 8px;"></i> NEW TOURNAMENT
        </button>
      </div>
    </div>
  </div>

  <!-- Setup Screen -->
  <div id="setupScreen" class="screen">
    <div class="container">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <div style="display: flex; align-items: center;">
          <button id="setupBackBtn" class="header-action" style="background: none; border: none; color: var(--text-color); font-size: 1.2rem; margin-right: 10px; padding: 0.5rem; display: flex; align-items: center; justify-content: center; min-height: 40px; min-width: 40px;">
            <i class="fas fa-arrow-left"></i>
          </button>
          <h2 class="screen-title" style="margin-bottom: 0;">
            <i class="fas fa-plus-circle" style="color: var(--primary-color); margin-right: 8px;"></i> New Tournament
          </h2>
        </div>
      </div>
      
      <!-- Tournament Type Selection -->
      <div class="card" id="tournamentTypeCard">
        <div style="margin-bottom: 1.5rem; text-align: center;">
          <div style="width: 80px; height: 80px; margin: 0 auto 1rem; background-color: var(--primary-color); border-radius: 50%; display: flex; justify-content: center; align-items: center;">
            <i class="fas fa-table-tennis" style="font-size: 2.5rem; color: white;"></i>
          </div>
          <h3 style="margin: 0; font-size: 1.2rem; color: var(--text-color);">Select Tournament Type</h3>
        </div>
        
        <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
          <div class="tournament-type-option" data-type="mexicano" style="flex: 1; padding: 1.5rem; border: 2px solid #e5e7eb; border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.2s ease;">
            <h4 style="margin-top: 0;">Mexicano</h4>
            <p style="margin-bottom: 0; color: var(--text-light); font-size: 0.9rem;">Score-based pairing (strongest with weakest)</p>
          </div>
          <div class="tournament-type-option" data-type="americano" style="flex: 1; padding: 1.5rem; border: 2px solid #e5e7eb; border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.2s ease;">
            <h4 style="margin-top: 0;">Americano</h4>
            <p style="margin-bottom: 0; color: var(--text-light); font-size: 0.9rem;">Rotation-based pairing system</p>
          </div>
        </div>
        
        <button id="continueSetupBtn" class="btn btn-primary btn-block">Continue</button>
      </div>
      
      <!-- Tournament Details Form -->
      <div class="card" id="tournamentDetailsCard" style="display: none;">
        <div style="margin-bottom: 1.5rem; text-align: center;">
          <div style="width: 60px; height: 60px; margin: 0 auto 1rem; background-color: var(--primary-color); border-radius: 50%; display: flex; justify-content: center; align-items: center;">
            <i class="fas fa-cog" style="font-size: 1.8rem; color: white;"></i>
          </div>
          <h3 style="margin: 0; font-size: 1.2rem; color: var(--text-color);">Tournament Setup</h3>
          <p style="margin: 0.5rem 0 0 0; font-size: 0.95rem; color: var(--text-light);">Configure your <span id="tournamentTypeLabel">Padel</span> tournament</p>
        </div>
        
        <form id="setupForm">
          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-trophy" style="margin-right: 8px; color: var(--primary-color);"></i>
              Tournament Name
            </label>
            <input type="text" id="tournamentName" class="form-control" placeholder="Enter tournament name" required>
          </div>
          
          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-users" style="margin-right: 8px; color: var(--primary-color);"></i>
              Number of Players: <span id="playerCountDisplay" class="player-count-value">4</span>
            </label>
            <div class="player-count-range">
              <span class="range-label">4</span>
              <input type="range" id="playerCount" min="4" max="32" value="4" class="form-control" style="flex: 1;">
              <span class="range-label">32</span>
            </div>
            <div class="rest-info" id="restInfo">
              <i class="fas fa-info-circle" style="margin-right: 5px;"></i>
              With 4 players, all players will play every round.
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-table-tennis" style="margin-right: 8px; color: var(--primary-color);"></i>
              Number of Courts
            </label>
            <select id="courtCount" class="form-control">
              <option value="1" selected>1 court</option>
              <option value="2">2 courts</option>
              <option value="3">3 courts</option>
              <option value="4">4 courts</option>
              <option value="5">5 courts</option>
              <option value="6">6 courts</option>
              <option value="7">7 courts</option>
              <option value="8">8 courts</option>
            </select>
          </div>
          
          <div id="playerSelection" class="form-group">
            <label class="form-label">
              <i class="fas fa-user-friends" style="margin-right: 8px; color: var(--primary-color);"></i>
              Player Selection
            </label>
            <div class="player-selection-tabs" style="display: flex; margin-bottom: 1rem;">
              <div id="existingPlayersTab" class="player-selection-tab active" style="flex: 1; padding: 0.75rem; text-align: center; border-bottom: 2px solid var(--primary-color); cursor: pointer;">
                Existing Players
              </div>
              <div id="newPlayersTab" class="player-selection-tab" style="flex: 1; padding: 0.75rem; text-align: center; border-bottom: 2px solid #e5e7eb; cursor: pointer;">
                New Players
              </div>
            </div>
            
            <div id="existingPlayersPanel">
              <div style="border: 1px solid var(--border-color); border-radius: 8px; padding: 0.5rem;">
                <div id="registeredPlayersList" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
                  <!-- Existing players will be populated here with checkboxes -->
                  <div class="empty-state" style="text-align: center; padding: 2rem; grid-column: span 2;">
                    <p>No saved players yet. Add players in the Players section.</p>
                  </div>
                </div>
              </div>
            </div>
            
            <div id="newPlayersPanel" style="display: none;">
              <div id="playerInputs" style="margin-top: 1rem;">
                <!-- Player inputs will be generated here -->
              </div>
            </div>
          </div>
          
          <button type="submit" class="btn btn-primary btn-block" style="margin-top: 1.5rem;" id="startTournamentBtn">
            <i class="fas fa-play"></i> Start Tournament
          </button>
          <button type="button" id="backToTypeBtn" class="btn btn-block" style="margin-top: 1rem;">
            <i class="fas fa-arrow-left"></i> Back to Type Selection
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Rounds Screen -->
  <div id="roundsScreen" class="screen">
    <div class="container">
      <div style="margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
        <div style="display: flex; align-items: center;">
          <button id="roundsBackBtn" class="header-action" style="background: none; border: none; color: var(--text-color); font-size: 1.2rem; margin-right: 10px; padding: 0.5rem; display: flex; align-items: center; justify-content: center; min-height: 40px; min-width: 40px;">
            <i class="fas fa-arrow-left"></i>
          </button>
          <h2 class="screen-title" style="margin-bottom: 0.5rem; margin-right: 1rem;">
            <i class="fas fa-table-tennis" style="color: var(--primary-color); margin-right: 8px;"></i> Matches
          </h2>
        </div>
        <div style="display: flex; gap: 1rem; align-items: center;">
          <button id="tournamentDeleteBtn" class="btn btn-tiny btn-danger">
            <i class="fas fa-trash-alt" style="margin-right: 3px;"></i> Delete
          </button>
          <div style="font-size: 0.9rem; background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end)); color: white; padding: 0.5rem 1rem; border-radius: 20px; cursor: pointer;" onclick="refreshFromDB()">
            <i class="fas fa-wifi" style="margin-right: 5px;"></i> Real-time sync
          </div>
        </div>
      </div>
      
      <div class="card" style="padding: 1rem; margin-bottom: 1.5rem;">
        <div class="rounds-nav" id="roundsNav">
          <!-- Round tabs will be generated here -->
        </div>
      </div>
      
      <div id="matchesContainer">
        <!-- Matches will be displayed here -->
        
        <!-- Empty state will be replaced by actual matches -->
        <div class="empty-state" style="text-align: center; padding: 3rem 1.5rem;">
          <img src="https://cdn.pixabay.com/photo/2021/06/04/06/54/racket-6308994_640.jpg" alt="Match Ready" style="width: 150px; height: 150px; object-fit: cover; border-radius: 50%; margin-bottom: 1.5rem; border: 4px solid white; box-shadow: 0 6px 16px var(--shadow-color);">
          <h3 style="font-size: 1.4rem; margin-bottom: 1rem; color: var(--text-color);">No matches yet</h3>
          <p style="color: var(--text-light); margin-bottom: 1.5rem;">Select or create a tournament to get started</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Players Screen -->
  <div id="playersScreen" class="screen">
    <div class="container">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 0.5rem;">
        <h2 class="screen-title" style="margin-bottom: 0; margin-right: 0.5rem;">
          <i class="fas fa-users" style="color: var(--primary-color); margin-right: 8px;"></i> Players
        </h2>
        <button id="addPlayerBtn" class="btn btn-small btn-primary">
          <i class="fas fa-plus" style="margin-right: 5px;"></i> Add Player
        </button>
      </div>
      <div class="card">
        <div style="display: flex; justify-content: space-between; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-color);">
          <div style="font-weight: 600; color: var(--text-color); font-size: 0.9rem;">PLAYER DIRECTORY</div>
          <div style="font-size: 0.9rem; color: var(--text-light);">
            <i class="fas fa-sort-alpha-down" style="margin-right: 5px;"></i> Name
          </div>
        </div>
        <div id="playersList">
          <!-- Player items will be populated here -->
          
          <!-- Empty state when no players are added -->
          <div class="empty-state" style="text-align: center; padding: 2rem 1rem;">
            <div style="width: 80px; height: 80px; margin: 0 auto 1.5rem; background-color: #f0f0f0; border-radius: 50%; display: flex; justify-content: center; align-items: center;">
              <i class="fas fa-user-plus" style="font-size: 2.5rem; color: var(--primary-color);"></i>
            </div>
            <h3 style="font-size: 1.4rem; margin-bottom: 1rem; color: var(--text-color);">No players yet</h3>
            <p style="color: var(--text-light); margin-bottom: 1.5rem;">Add your first player to get started</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Leaderboard Screen -->
  <div id="leaderboardScreen" class="screen">
    <div class="container">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <div style="display: flex; align-items: center;">
          <button id="leaderboardBackBtn" class="header-action" style="background: none; border: none; color: var(--text-color); font-size: 1.2rem; margin-right: 10px; padding: 0.5rem; display: flex; align-items: center; justify-content: center; min-height: 40px; min-width: 40px;">
            <i class="fas fa-arrow-left"></i>
          </button>
          <h2 class="screen-title" style="margin-bottom: 0;">
            <i class="fas fa-trophy" style="color: var(--primary-color); margin-right: 8px;"></i> Statistics
          </h2>
        </div>
        <div style="font-size: 0.9rem; color: var(--text-light); display: flex; align-items: center; cursor: pointer;" id="refreshStatisticsBtn" onclick="refreshLeaderboardFromDB()">
          <i class="fas fa-sync-alt" style="margin-right: 5px;"></i> Refresh data
        </div>
      </div>
      <div class="card">
        <div style="display: flex; justify-content: space-between; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-color);">
          <div style="font-weight: 600; color: var(--text-color); font-size: 0.9rem;">PLAYER STATISTICS</div>
          <div style="font-size: 0.9rem; color: var(--text-light);">
            <i class="fas fa-chart-bar" style="margin-right: 5px;"></i> Summary
          </div>
        </div>
        <div id="leaderboardList" style="padding: 0; display: flex; flex-direction: column; gap: 0; max-width: 100%; overflow-x: hidden;">
          <!-- Statistics will be generated here -->
          
          <!-- Empty state will be replaced by actual data -->
          <div class="empty-state" style="text-align: center; padding: 2rem 1rem;">
            <img src="https://cdn.pixabay.com/photo/2021/09/10/06/47/paddle-tennis-6612340_150.jpg" alt="Trophy" style="width: 100px; height: 100px; object-fit: cover; border-radius: 50%; margin-bottom: 1rem; opacity: 0.7;">
            <p style="color: var(--text-light); margin-bottom: 0;">Complete matches to see player statistics</p>
          </div>
        </div>
        
        <div class="export-section" style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
          <h4 style="font-size: 1.1rem; margin-bottom: 1rem; display: flex; align-items: center;">
            <i class="fas fa-share-alt" style="margin-right: 8px; color: var(--primary-color);"></i> 
            Export Results
          </h4>
          <div class="export-buttons" style="display: flex; gap: 1rem;">
            <button id="exportPDF" class="btn btn-small btn-primary" style="flex: 1; display: flex; align-items: center; justify-content: center;">
              <i class="fas fa-file-pdf"></i> PDF
            </button>
            <button id="exportPNG" class="btn btn-small btn-success" style="flex: 1; display: flex; align-items: center; justify-content: center;">
              <i class="fas fa-image"></i> PNG
            </button>
            <button id="shareLeaderboard" class="btn btn-small" style="flex: 1; display: flex; align-items: center; justify-content: center; background-color: #3b82f6;">
              <i class="fas fa-share-alt"></i> Share
            </button>
          </div>
          <div style="margin-top: 1rem; text-align: center; font-size: 0.9rem; color: var(--text-light);">
            <i class="fas fa-info-circle"></i> Exported results include complete tournament data
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Rankings Screen -->
  <div id="rankingsScreen" class="screen">
    <div class="container">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 class="screen-title" style="margin-bottom: 0;">
          <i class="fas fa-medal" style="color: var(--primary-color); margin-right: 8px;"></i> Global Rankings
        </h2>
        <div style="font-size: 0.9rem; color: var(--text-light); display: flex; align-items: center;">
          <i class="fas fa-chart-line" style="margin-right: 5px;"></i> All-time stats
        </div>
      </div>
      <div class="card">
        <div style="display: flex; justify-content: space-between; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-color);">
          <div style="font-weight: 600; color: var(--text-color); font-size: 0.9rem;">GLOBAL LEADERBOARD</div>
          <div style="font-size: 0.9rem; color: var(--text-light);">
            <i class="fas fa-sort-amount-down" style="margin-right: 5px;"></i> Performance
          </div>
        </div>
        <div id="globalRankingsList">
          <!-- Global rankings will be populated here -->
          
          <!-- Empty state when no tournaments played -->
          <div class="empty-state" style="text-align: center; padding: 2rem 1rem;">
            <div style="width: 80px; height: 80px; margin: 0 auto 1.5rem; background-color: #f0f0f0; border-radius: 50%; display: flex; justify-content: center; align-items: center;">
              <i class="fas fa-medal" style="font-size: 2.5rem; color: var(--primary-color);"></i>
            </div>
            <h3 style="font-size: 1.4rem; margin-bottom: 1rem; color: var(--text-color);">No rankings yet</h3>
            <p style="color: var(--text-light); margin-bottom: 1.5rem;">Play tournaments to build your global ranking</p>
          </div>
        </div>
        
        <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
          <h4 style="font-size: 1.1rem; margin-bottom: 1rem; display: flex; align-items: center;">
            <i class="fas fa-info-circle" style="margin-right: 8px; color: var(--primary-color);"></i> 
            Ranking System
          </h4>
          <div style="font-size: 0.9rem; color: var(--text-light); line-height: 1.5;">
            <p style="margin-bottom: 0.5rem;"><strong>Performance Rating:</strong> Overall player skill (0-100)</p>
            <p style="margin-bottom: 0.5rem;"><strong>Win Rate:</strong> Percentage of matches won</p>
            <p style="margin-bottom: 0.5rem;"><strong>Average Points:</strong> Points earned per tournament</p>
            <p style="margin-bottom: 0;"><strong>Goal Difference:</strong> Points scored minus points conceded</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Screen -->
  <div id="settingsScreen" class="screen">
    <div class="container">
      <h2 class="screen-title">Settings</h2>
      <div class="card">
        <!-- Dark mode toggle removed as requested -->
        
        <div class="settings-section">
          <h3 class="settings-title">About</h3>
          <div class="settings-option">
            <div class="settings-option-label">
              <i class="fas fa-info-circle"></i>
              <span>App Info</span>
            </div>
            <button class="btn btn-small btn-primary" id="showAppInfoBtn"><i class="fas fa-eye"></i> View</button>
          </div>
          
          <div class="settings-option" style="margin-top: 15px;">
            <div class="settings-option-label">
              <i class="fas fa-download"></i>
              <span>Source Code</span>
            </div>
            <button class="btn btn-small btn-primary" id="downloadSourceBtn"><i class="fas fa-download"></i> Download</button>
          </div>
          <div class="about-section" style="display: none;" id="appInfoSection">
            <h4><i class="fas fa-table-tennis"></i> Padel Americano</h4>
            <p>A professional web app for managing Padel Americano tournaments with real-time synchronization and comprehensive scoring system.</p>
            
            <h4><i class="fas fa-user-circle"></i> Creator</h4>
            <p><a href="https://github.com/iamahuman321" target="_blank">@iamahuman321</a></p>
            
            <h4><i class="fas fa-code-branch"></i> GitHub Repository</h4>
            <p><a href="https://github.com/iamahuman321/Paddle/" target="_blank">github.com/iamahuman321/Paddle</a></p>
            
            <h4><i class="fas fa-star"></i> Key Features</h4>
            <ul>
              <li><i class="fas fa-award"></i> 21-Point Matches with automatic scoring</li>
              <li><i class="fas fa-users"></i> Flexible Player Count (4-14)</li>
              <li><i class="fas fa-calendar-plus"></i> Dynamic Round Generation</li>
              <li><i class="fas fa-sync-alt"></i> Real-time Synchronization</li>
              <li><i class="fas fa-file-export"></i> Export to PDF/PNG</li>
              <li><i class="fas fa-trophy"></i> Live Leaderboard</li>
              <li><i class="fas fa-moon"></i> Dark Mode Support</li>
            </ul>
            
            <h4><i class="fas fa-info-circle"></i> Version</h4>
            <p>v1.2.0 - © 2025 Padel Americano</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <a href="#" id="roundsTab" class="nav-item">
      <i class="fas fa-calendar-alt nav-icon"></i>
      <span>Rounds</span>
    </a>
    <a href="#" id="leaderboardTab" class="nav-item">
      <i class="fas fa-trophy nav-icon"></i>
      <span>Leaderboard</span>
    </a>
  </nav>

  <!-- Player Modal -->
  <div id="playerModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="playerModalTitle">Add Player</h3>
        <button class="modal-close" id="closePlayerModal">&times;</button>
      </div>
      <form id="playerForm">
        <div class="form-group">
          <label class="form-label">Player Name</label>
          <input type="text" id="playerName" class="form-control" placeholder="Enter player name" required>
        </div>
        <div class="form-group">
          <label class="form-label">Skill Level</label>
          <select id="playerSkillLevel" class="form-control">
            <option value="beginner">Beginner</option>
            <option value="intermediate" selected>Intermediate</option>
            <option value="advanced">Advanced</option>
            <option value="pro">Professional</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Notes</label>
          <textarea id="playerNotes" class="form-control" placeholder="Optional notes" rows="3"></textarea>
        </div>
        <button type="submit" id="savePlayerBtn" class="btn btn-primary btn-block">Save Player</button>
      </form>
    </div>
  </div>

  <!-- Canvas for export (hidden) -->
  <canvas id="exportCanvas" style="display: none;"></canvas>

  <!-- Firebase SDK -->
  <script src="https://lib.youware.com/youware-lib-editor.1754557047.js" id="yourware-lib"></script><script src="https://lib.youware.com/youware-lib-consumer.1752562065.js" id="yourware-lib"></script><script src="https://lib.youware.com/youware-lib-consumer.1752562065.js" id="yourware-lib"></script><script src="https://lib.youware.com/youware-lib-consumer.1752562065.js" id="yourware-lib"></script><script src="https://lib.youware.com/youware-lib-consumer.1752562065.js" id="yourware-lib"></script><script src="https://lib.youware.com/youware-lib-consumer.1752562065.js" id="yourware-lib"></script><script src="https://lib.youware.com/youware-lib-consumer.1752562065.js" id="yourware-lib"></script><script type="module">
    // Import Firebase functions
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import { getDatabase, ref, set, onValue, off, get, child } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDymQBpzDKLOyMAiAHTY-lFcPGc2zuMgbg",
      authDomain: "paddle-e3c7f.firebaseapp.com",
      databaseURL: "https://paddle-e3c7f-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "paddle-e3c7f",
      storageBucket: "paddle-e3c7f.firebasestorage.app",
      messagingSenderId: "270747215285",
      appId: "1:270747215285:web:9068d56bdafe6d21a7e5fc",
      measurementId: "G-SH67C8F715"
    };

    // Initialize Firebase with better error handling
    let database = null;
    let isOnline = false;
    try {
      const app = initializeApp(firebaseConfig);
      database = getDatabase(app);
      isOnline = true;
      console.log("Firebase initialized successfully");
      updateSyncStatus(true);
      
      // Test connection with a simple read
      const testRef = ref(database, '.info/connected');
      onValue(testRef, (snapshot) => {
        const connected = snapshot.val();
        if (connected) {
          console.log("Firebase RTDB: Connected");
          updateSyncStatus(true);
        } else {
          console.log("Firebase RTDB: Disconnected");
          updateSyncStatus(false);
        }
      });
      
    } catch (error) {
      console.warn("Firebase initialization failed:", error);
      console.log("App will work in offline mode using localStorage");
      isOnline = false;
      updateSyncStatus(false);
    }

    // Make Firebase functions globally available
    window.firebaseDB = database;
    window.firebaseRef = ref;
    window.firebaseSet = set;
    window.firebaseOnValue = onValue;
    window.firebaseOff = off;
    window.firebaseGet = get;
    window.firebaseChild = child;
    window.isFirebaseOnline = isOnline;
    
    // Enhanced connection monitoring
    if (database) {
      window.addEventListener('online', () => {
        console.log('Network: Back online, checking Firebase connection...');
        updateSyncStatus(true);
        // Reload tournaments from Firebase when coming back online
        loadTournaments();
      });
      
      window.addEventListener('offline', () => {
        console.log('Network: Offline, switching to localStorage mode');
        updateSyncStatus(false);
        // Switch to localStorage when going offline
        fallbackToLocalStorage();
      });
    }
  </script>

  <script>
    // App State
    const appState = {
      currentScreen: 'tournamentListScreen',
      currentTournament: null,
      tournaments: {},
      players: [],
      navigation: {
        activeTab: 'roundsTab'
      },
      tournamentType: 'mexicano' // Default tournament type
    };

    // DOM Elements
    const screens = {
      tournamentListScreen: document.getElementById('tournamentListScreen'),
      setupScreen: document.getElementById('setupScreen'),
      roundsScreen: document.getElementById('roundsScreen'),
      leaderboardScreen: document.getElementById('leaderboardScreen'),
      settingsScreen: document.getElementById('settingsScreen'),
      playersScreen: document.getElementById('playersScreen'),
      rankingsScreen: document.getElementById('rankingsScreen')
    };

    const navTabs = {
      roundsTab: document.getElementById('roundsTab'),
      leaderboardTab: document.getElementById('leaderboardTab')
    };

    // Update sync status indicator (removed from UI but keep for logging)
    function updateSyncStatus(online) {
      console.log(online ? 'Firebase: Connected' : 'Firebase: Offline - using localStorage');
      window.isFirebaseOnline = online;
    }

    // Function to refresh data from the database
    function refreshFromDB() {
      // Show a brief loading animation or feedback
      const syncElement = event.target.closest('div');
      const originalContent = syncElement.innerHTML;
      syncElement.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 5px;"></i> Refreshing...';
      
      // Load from Firebase
      if (window.firebaseDB && window.isFirebaseOnline && navigator.onLine) {
        const tournamentId = appState.currentTournament.id;
        const dbRef = window.firebaseRef(window.firebaseDB);
        
        window.firebaseGet(window.firebaseChild(dbRef, `tournaments/${tournamentId}`))
          .then((snapshot) => {
            if (snapshot.exists()) {
              const freshTournament = snapshot.val();
              
              // Update the tournament in the state
              appState.tournaments[tournamentId] = freshTournament;
              appState.currentTournament = freshTournament;
              
              // Calculate player stats based on the fresh data
              if (appState.currentTournament && appState.currentTournament.players && appState.currentTournament.rounds) {
                calculatePlayerStats(appState.currentTournament.players, appState.currentTournament.rounds);
              }
              
              // Refresh displays
              renderRoundTabs();
              renderMatches(appState.currentTournament.currentRound || 0);
              
              // Success feedback
              syncElement.innerHTML = '<i class="fas fa-check" style="margin-right: 5px;"></i> Updated';
              setTimeout(() => {
                syncElement.innerHTML = originalContent;
              }, 2000);
            } else {
              console.log('No tournament data found in Firebase');
              syncElement.innerHTML = '<i class="fas fa-exclamation-triangle" style="margin-right: 5px;"></i> No data';
              setTimeout(() => {
                syncElement.innerHTML = originalContent;
              }, 2000);
            }
          })
          .catch((error) => {
            console.error('Error refreshing data from Firebase:', error);
            syncElement.innerHTML = '<i class="fas fa-times" style="margin-right: 5px;"></i> Error';
            setTimeout(() => {
              syncElement.innerHTML = originalContent;
            }, 2000);
          });
      } else {
        console.log('Firebase not available or offline');
        syncElement.innerHTML = '<i class="fas fa-cloud-slash" style="margin-right: 5px;"></i> Offline';
        setTimeout(() => {
          syncElement.innerHTML = originalContent;
        }, 2000);
      }
    }
    
    // Function to refresh leaderboard from database
    function refreshLeaderboardFromDB() {
      // Show a brief loading animation or feedback
      const refreshBtn = document.getElementById('refreshStatisticsBtn');
      const originalContent = refreshBtn.innerHTML;
      refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 5px;"></i> Refreshing...';
      
      // Recalculate stats based on current data
      if (appState.currentTournament && appState.currentTournament.players && appState.currentTournament.rounds) {
        calculatePlayerStats(appState.currentTournament.players, appState.currentTournament.rounds);
        renderLeaderboard();
      }
      
      // If Firebase is available, get fresh data
      if (window.firebaseDB && window.isFirebaseOnline && navigator.onLine) {
        // Load global rankings data
        const dbRef = window.firebaseRef(window.firebaseDB);
        window.firebaseGet(window.firebaseChild(dbRef, 'players'))
          .then((snapshot) => {
            if (snapshot.exists()) {
              appState.players = snapshot.val();
            }
            
            // Force recalculation of global rankings
            renderGlobalRankings();
            
            // Success feedback
            refreshBtn.innerHTML = '<i class="fas fa-check" style="margin-right: 5px;"></i> Updated';
            setTimeout(() => {
              refreshBtn.innerHTML = originalContent;
            }, 2000);
          })
          .catch((error) => {
            console.error('Error refreshing data from Firebase:', error);
            refreshBtn.innerHTML = '<i class="fas fa-times" style="margin-right: 5px;"></i> Error';
            setTimeout(() => {
              refreshBtn.innerHTML = originalContent;
            }, 2000);
          });
      } else {
        // Just use local data
        renderGlobalRankings();
        
        refreshBtn.innerHTML = '<i class="fas fa-check" style="margin-right: 5px;"></i> Updated (local)';
        setTimeout(() => {
          refreshBtn.innerHTML = originalContent;
        }, 2000);
      }
    }

    // Function to change the current screen
    function showScreen(screenId) {
      // Hide all screens
      Object.values(screens).forEach(screen => {
        screen.classList.remove('active');
      });
      
      // Show the requested screen
      screens[screenId].classList.add('active');
      
      // Update app state
      appState.currentScreen = screenId;
      
      // Update header and navigation
      updateHeader(screenId);
      updateNavigation(screenId);
      
      // Update active sidebar menu item based on screen
      document.querySelectorAll('.sidebar-menu-item').forEach(menuItem => {
        menuItem.classList.remove('active');
      });
      
      // Map screen IDs to sidebar menu items
      const menuMap = {
        'tournamentListScreen': 'tournaments',
        'playersScreen': 'players',
        'rankingsScreen': 'rankings',
        'settingsScreen': 'settings'
      };
      
      if (menuMap[screenId]) {
        const menuItem = document.querySelector(`.sidebar-menu-item[data-page="${menuMap[screenId]}"]`);
        if (menuItem) {
          menuItem.classList.add('active');
        }
      }
      
      // Prevent scrolling if content fits within viewport
      setTimeout(() => {
        checkAndPreventScrolling(screenId);
      }, 100);
    }
    
    // Function to check if content fits in viewport and prevent scrolling if it does
    function checkAndPreventScrolling(screenId) {
      const screen = screens[screenId];
      if (!screen) return;
      
      const screenContent = screen.querySelector('.container');
      if (!screenContent) return;
      
      const screenHeight = screen.clientHeight;
      const contentHeight = screenContent.scrollHeight;
      
      // If content is shorter than screen, prevent scrolling
      if (contentHeight <= screenHeight) {
        screen.style.overflowY = 'hidden';
      } else {
        screen.style.overflowY = 'auto';
      }
    }

    // Update header based on current screen
    function updateHeader(screenId) {
      const backBtn = document.getElementById('backBtn');
      const menuBtn = document.getElementById('menuBtn');
      
      // Show the menu button for all screens, remove back button completely
      backBtn.style.display = 'none';
      menuBtn.style.display = 'block';
    }

    // Update navigation visibility
    function updateNavigation(screenId) {
      const bottomNav = document.querySelector('.bottom-nav');
      // Only show bottom nav when inside a tournament (not on home/other screens)
      if (appState.currentTournament && (screenId === 'roundsScreen' || screenId === 'leaderboardScreen')) {
        bottomNav.style.display = 'flex';
        
        // Update active tab
        if (screenId === 'roundsScreen') {
          setActiveTab('roundsTab');
        } else if (screenId === 'leaderboardScreen') {
          setActiveTab('leaderboardTab');
        }
      } else {
        bottomNav.style.display = 'none';
      }
    }

    // Function to set the active navigation tab
    function setActiveTab(tabId) {
      // Remove active class from all tabs
      Object.values(navTabs).forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Add active class to the selected tab
      navTabs[tabId].classList.add('active');
      
      // Update app state
      appState.navigation.activeTab = tabId;
    }

    // Update player count display and rest info
    function updatePlayerCountDisplay() {
      const playerCount = parseInt(document.getElementById('playerCount').value);
      const display = document.getElementById('playerCountDisplay');
      const restInfo = document.getElementById('restInfo');
      
      display.textContent = playerCount;
      
      const playersPerMatch = 4;
      const restingPlayers = playerCount % playersPerMatch;
      
      if (restingPlayers === 0) {
        restInfo.textContent = `With ${playerCount} players, all players will play every round.`;
      } else {
        restInfo.textContent = `With ${playerCount} players, ${restingPlayers} player(s) will rest each round and receive 10 bonus points per rest.`;
      }
    }

    // Generate player input fields
    function generatePlayerInputs(count) {
      const container = document.getElementById('playerInputs');
      container.innerHTML = '';
      
      for (let i = 0; i < count; i++) {
        const formGroup = document.createElement('div');
        formGroup.className = 'form-group';
        
        const label = document.createElement('label');
        label.className = 'form-label';
        label.htmlFor = `player${i+1}`;
        label.textContent = `Player ${i+1}`;
        
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'form-control';
        input.id = `player${i+1}`;
        input.name = `player${i+1}`;
        input.placeholder = `Enter player ${i+1} name`;
        input.required = true;
        
        formGroup.appendChild(label);
        formGroup.appendChild(input);
        container.appendChild(formGroup);
      }
    }

    // Enhanced match generation with rest system
    function generateMatches(players, roundNumber, restingPlayers = []) {
      const matches = [];
      const playersPerMatch = 4;
      
      // Get players who are not resting this round
      const activePlayers = players.filter(p => !restingPlayers.includes(p.id));
      
      // Get the tournament type
      const tournamentType = appState.currentTournament?.type || 'mexicano';
      
      // Generate matches from active players
      for (let i = 0; i < activePlayers.length; i += playersPerMatch) {
        if (i + 3 < activePlayers.length) {
          const courtNumber = Math.floor(i / playersPerMatch) + 1;
          
          let teamA, teamB;
          
          if (tournamentType === 'mexicano') {
            if (roundNumber === 0) {
              // First round: Sequential pairing
              teamA = [activePlayers[i].id, activePlayers[i+1].id];
              teamB = [activePlayers[i+2].id, activePlayers[i+3].id];
            } else {
              // Subsequent rounds: Score-based pairing (Mexicano format)
              teamA = [activePlayers[i].id, activePlayers[i+3].id]; // Strongest with weakest
              teamB = [activePlayers[i+1].id, activePlayers[i+2].id]; // 2nd strongest with 2nd weakest
            }
          } else {
            // Americano format: Rotation-based pairing
            // In Americano, we rotate players based on round number
            const rotationOffset = roundNumber % activePlayers.length;
            
            // Get rotated player indices
            const a = (i + rotationOffset) % activePlayers.length;
            const b = (i + 1 + rotationOffset) % activePlayers.length;
            const c = (i + 2 + rotationOffset) % activePlayers.length;
            const d = (i + 3 + rotationOffset) % activePlayers.length;
            
            // Create teams with players at rotated indices
            teamA = [activePlayers[a].id, activePlayers[b].id];
            teamB = [activePlayers[c].id, activePlayers[d].id];
          }
          
          matches.push({
            id: `match-${roundNumber}-${courtNumber-1}`,
            roundNumber: roundNumber,
            courtNumber: courtNumber,
            teamA: teamA,
            teamB: teamB,
            scoreA: 0,
            scoreB: 0,
            completed: false
          });
        }
      }
      
      return matches;
    }

    // Determine which players should rest in a round
    function getRestingPlayers(players, roundNumber) {
      const playersPerMatch = 4;
      const restingCount = players.length % playersPerMatch;
      
      if (restingCount === 0) return [];
      
      // Sort players by rest count so those with fewer rests are chosen first
      // This ensures more balanced rest distribution
      const sortedByRest = [...players].sort((a, b) => {
        if ((a.restsCount || 0) !== (b.restsCount || 0)) {
          return (a.restsCount || 0) - (b.restsCount || 0); // Players with fewer rests first
        }
        return 0; // Keep original order if rest counts are equal
      });
      
      // For first round, just pick the first N players
      // For subsequent rounds, use a rotating system based on rest count
      const restingPlayers = [];
      
      // Take the first restingCount players with the lowest rest count
      for (let i = 0; i < restingCount; i++) {
        restingPlayers.push(sortedByRest[i].id);
      }
      
      return restingPlayers;
    }

    // Calculate player stats with corrected scoring system - only counting rounds in database
    function calculatePlayerStats(players, rounds) {
      // Reset player scores
      players.forEach(player => {
        player.score = 0;
        player.matchesPlayed = 0;
        player.matchesWon = 0;
        player.matchesLost = 0;
        player.matchesTied = 0;
        player.pointsFor = 0;
        player.pointsAgainst = 0;
        player.restsCount = 0;
      });
      
      // Ensure we only process valid rounds that exist in the database
      if (!rounds || !Array.isArray(rounds)) {
        console.warn('No valid rounds found for calculation');
        return players;
      }
      
      // Calculate rest counts first - only from actual rounds in the database
      rounds.forEach(round => {
        if (!round) return; // Skip invalid rounds
        
        const restingPlayers = round.restingPlayers || [];
        restingPlayers.forEach(playerId => {
          const player = players.find(p => p.id === playerId);
          if (player) player.restsCount++;
        });
      });
      
      // Calculate match-based scores - only from rounds that exist in the database
      rounds.forEach(round => {
        if (!round || !round.matches) return; // Skip invalid rounds or rounds without matches
        
        round.matches.forEach(match => {
          if (match && match.completed) {
            // Get players from both teams
            const teamAPlayers = match.teamA.map(playerId => 
              players.find(p => p.id === playerId)
            ).filter(Boolean); // Filter out undefined players
            
            const teamBPlayers = match.teamB.map(playerId => 
              players.find(p => p.id === playerId)
            ).filter(Boolean); // Filter out undefined players
            
            // Update matches played count
            [...teamAPlayers, ...teamBPlayers].forEach(player => {
              player.matchesPlayed++;
            });
            
            // Update points and stats based on the scores
            teamAPlayers.forEach(player => {
              // Add match score to player's total score
              player.score += match.scoreA;
              player.pointsFor += match.scoreA;
              player.pointsAgainst += match.scoreB;
              
              // Update win/loss/tie status
              if (match.scoreA > match.scoreB) player.matchesWon++;
              else if (match.scoreA < match.scoreB) player.matchesLost++;
              else player.matchesTied++;
            });
            
            teamBPlayers.forEach(player => {
              // Add match score to player's total score
              player.score += match.scoreB;
              player.pointsFor += match.scoreB;
              player.pointsAgainst += match.scoreA;
              
              // Update win/loss/tie status
              if (match.scoreB > match.scoreA) player.matchesWon++;
              else if (match.scoreB < match.scoreA) player.matchesLost++;
              else player.matchesTied++;
            });
          }
        });
      });
      
      // Add rest bonus points
      players.forEach(player => {
        if (player.restsCount > 0) {
          player.score += player.restsCount * 10; // 10 bonus points per rest
        }
      });
      
      return players;
    }

    // Render matches for a specific round
    function renderMatches(roundIndex) {
      const matchesContainer = document.getElementById('matchesContainer');
      matchesContainer.innerHTML = '';
      
      if (!appState.currentTournament.rounds[roundIndex]) {
        matchesContainer.innerHTML = '<div class="loading">No matches available for this round</div>';
        return;
      }
      
      const round = appState.currentTournament.rounds[roundIndex];
      const matches = round.matches;
      const restingPlayers = round.restingPlayers || [];
      
      // Show resting players first
      if (restingPlayers.length > 0) {
        const restCard = document.createElement('div');
        restCard.className = 'rest-card';
        
        const restingPlayerNames = restingPlayers.map(playerId => 
          appState.currentTournament.players.find(p => p.id === playerId)?.name || 'Unknown'
        );
        
        restCard.innerHTML = `
          <div class="rest-player">
            <i class="fas fa-chair"></i> Resting: ${restingPlayerNames.join(', ')}
          </div>
          <div class="rest-bonus">+10 bonus points per rest</div>
        `;
        
        matchesContainer.appendChild(restCard);
      }
      
      // Show matches
      matches.forEach(match => {
        const teamAPlayers = match.teamA.map(playerId => 
          appState.currentTournament.players.find(p => p.id === playerId)
        );
        
        const teamBPlayers = match.teamB.map(playerId => 
          appState.currentTournament.players.find(p => p.id === playerId)
        );
        
        const teamANames = teamAPlayers.map(p => p.name);
        const teamBNames = teamBPlayers.map(p => p.name);
        
        const matchCard = document.createElement('div');
        matchCard.className = 'match-card';
        matchCard.dataset.matchId = match.id;
        
        matchCard.innerHTML = `
          <div class="match-header">
            <div class="match-title">Court ${match.courtNumber}</div>
            <div class="match-status">${match.completed ? 'Completed' : 'In Progress'}</div>
          </div>
          <div class="match-teams">
            <div class="match-team team-a">
              <div class="team-name">Team A</div>
              <div class="team-players">${teamANames.join(' & ')}</div>
            </div>
            <div class="match-team team-b">
              <div class="team-name">Team B</div>
              <div class="team-players">${teamBNames.join(' & ')}</div>
            </div>
          </div>
          <div class="match-score">
            <input type="number" class="score-input team-a-score" value="${match.completed ? match.scoreA : ''}" min="0" max="21" ${match.completed ? 'disabled' : ''} placeholder="">
            <span class="score-display">vs</span>
            <input type="number" class="score-input team-b-score" value="${match.completed ? match.scoreB : ''}" min="0" max="21" ${match.completed ? 'disabled' : ''} placeholder="">
          </div>
          <div style="text-align: center; font-size: 0.875rem; color: var(--text-light); margin-top: 0.5rem;">
            Playing to 21 points total
          </div>
          ${!match.completed ? 
            `<button class="btn btn-block save-score-btn" data-match-id="${match.id}">Save Score</button>` : 
            ''
          }
        `;
        
        matchesContainer.appendChild(matchCard);
        
        // Add validation for total score
        if (!match.completed) {
          const scoreAInput = matchCard.querySelector('.team-a-score');
          const scoreBInput = matchCard.querySelector('.team-b-score');
          
          // Validate when team A score changes
          scoreAInput.addEventListener('input', function() {
            validateMatchScore(scoreAInput, scoreBInput);
          });
          
          // Validate when team B score changes
          scoreBInput.addEventListener('input', function() {
            validateMatchScore(scoreBInput, scoreAInput);
          });
        }
      });
      
      // Add event listeners to save score buttons
      const saveButtons = document.querySelectorAll('.save-score-btn');
      saveButtons.forEach(button => {
        button.addEventListener('click', function() {
          const matchId = this.dataset.matchId;
          const matchCard = document.querySelector(`.match-card[data-match-id="${matchId}"]`);
          if (matchCard) {
            const scoreA = parseInt(matchCard.querySelector('.team-a-score').value) || 0;
            const scoreB = parseInt(matchCard.querySelector('.team-b-score').value) || 0;
            const totalScore = scoreA + scoreB;
            
            if (scoreA >= 0 && scoreA <= 21 && scoreB >= 0 && scoreB <= 21) {
              if (totalScore === 21) {
                saveMatchScore(matchId, scoreA, scoreB);
              } else {
                alert('Total score must be 21 points');
              }
            } else {
              alert('Each team score must be between 0 and 21');
            }
          }
        });
      });
    }

    // Function to validate match score as user types
    function validateMatchScore(changedInput, otherInput) {
      const changedScore = parseInt(changedInput.value) || 0;
      
      if (changedScore > 21) {
        changedInput.value = 21;
      }
      
      // If user clears the input, don't auto-fill the other input
      if (changedInput.value === "") {
        return;
      }
      
      const suggestedOtherScore = 21 - changedScore;
      
      // Only auto-suggest the other score if it's empty or the total would be over 21
      if (otherInput.value === "" || parseInt(otherInput.value) + changedScore > 21) {
        otherInput.value = suggestedOtherScore > 0 ? suggestedOtherScore : "";
      }
    }

    // Save match score with real-time sync
    function saveMatchScore(matchId, scoreA, scoreB) {
      // Find the match and update the score
      for (let r = 0; r < appState.currentTournament.rounds.length; r++) {
        const round = appState.currentTournament.rounds[r];
        for (let m = 0; m < round.matches.length; m++) {
          const match = round.matches[m];
          
          if (match.id === matchId) {
            match.scoreA = scoreA;
            match.scoreB = scoreB;
            match.completed = true;
            match.completedAt = Date.now();
            
            // Recalculate player stats
            appState.currentTournament.players = calculatePlayerStats(
              appState.currentTournament.players, 
              appState.currentTournament.rounds
            );
            
            // Save to Firebase and localStorage
            saveTournamentData(appState.currentTournament);
            
            // Re-render current round
            renderMatches(r);
            
            // Update leaderboard
            renderLeaderboard();
            
            return;
          }
        }
      }
    }

    // Add new round functionality with recalculation of standings
    function addNewRound() {
      if (!appState.currentTournament) return;
      
      // Check if all matches in the current round have scores
      if (appState.currentTournament.rounds.length > 0) {
        const currentRound = appState.currentTournament.rounds[appState.currentTournament.rounds.length - 1];
        const hasIncompleteMatches = currentRound.matches.some(match => 
          match.scoreA === null || match.scoreA === undefined || 
          match.scoreB === null || match.scoreB === undefined
        );
        
        if (hasIncompleteMatches) {
          // Show error message
          alert('Please complete all match scores in the current round before adding a new round');
          return;
        }
      }
      
      // First recalculate all player stats to ensure we have accurate data
      appState.currentTournament.players = calculatePlayerStats(
        [...appState.currentTournament.players],
        appState.currentTournament.rounds
      );
      
      const newRoundNumber = appState.currentTournament.rounds.length;
      
      // Sort players by current standings for next round pairing, using the recalculated stats
      const sortedPlayers = [...appState.currentTournament.players].sort((a, b) => {
        if (b.score !== a.score) return b.score - a.score;
        const aDiff = a.pointsFor - a.pointsAgainst;
        const bDiff = b.pointsFor - b.pointsAgainst;
        if (bDiff !== aDiff) return bDiff - aDiff;
        return b.pointsFor - a.pointsFor;
      });
      
      // Determine resting players for this round
      const restingPlayers = getRestingPlayers(sortedPlayers, newRoundNumber);
      
      // Generate matches
      const matches = generateMatches(sortedPlayers, newRoundNumber, restingPlayers);
      
      // Add new round
      appState.currentTournament.rounds.push({
        roundNumber: newRoundNumber,
        matches: matches,
        restingPlayers: restingPlayers,
        createdAt: Date.now() // Add timestamp for better tracking
      });
      
      // Save tournament
      saveTournamentData(appState.currentTournament);
      
      // Update UI
      renderRoundTabs();
      
      // Switch to new round
      appState.currentTournament.currentRound = newRoundNumber;
      renderMatches(newRoundNumber);
      
      // Also update the leaderboard to reflect the new round
      renderLeaderboard();
    }

    // Render round tabs with add round button
    function renderRoundTabs() {
      const roundsNav = document.getElementById('roundsNav');
      roundsNav.innerHTML = '';
      
      appState.currentTournament.rounds.forEach((round, index) => {
        const roundTab = document.createElement('div');
        roundTab.className = `round-tab ${index === appState.currentTournament.currentRound ? 'active' : ''}`;
        roundTab.textContent = `Round ${index + 1}`;
        roundTab.dataset.roundIndex = index;
        
        roundTab.addEventListener('click', function() {
          const roundIndex = parseInt(this.dataset.roundIndex, 10);
          appState.currentTournament.currentRound = roundIndex;
          
          // Update active tab
          document.querySelectorAll('.round-tab').forEach(tab => {
            tab.classList.remove('active');
          });
          this.classList.add('active');
          
          // Render matches for the selected round
          renderMatches(roundIndex);
        });
        
        roundsNav.appendChild(roundTab);
      });
      
      // Add "Add Round" button
      const addRoundBtn = document.createElement('button');
      addRoundBtn.className = 'add-round-btn';
      addRoundBtn.innerHTML = '<i class="fas fa-plus"></i> Add Round';
      addRoundBtn.addEventListener('click', addNewRound);
      
      roundsNav.appendChild(addRoundBtn);
    }

    // Render leaderboard
    function renderLeaderboard() {
      const leaderboardList = document.getElementById('leaderboardList');
      leaderboardList.innerHTML = '';
      
      if (!appState.currentTournament || !appState.currentTournament.players) {
        leaderboardList.innerHTML = `
          <div class="empty-state" style="text-align: center; padding: 2rem 1rem;">
            <img src="https://cdn.pixabay.com/photo/2021/09/10/06/47/paddle-tennis-6612340_150.jpg" alt="Trophy" style="width: 100px; height: 100px; object-fit: cover; border-radius: 50%; margin-bottom: 1rem; opacity: 0.7;">
            <p style="color: var(--text-light); margin-bottom: 0;">No players found</p>
          </div>
        `;
        return;
      }
      
      // Ensure we have fresh player stats before rendering
      const currentPlayers = calculatePlayerStats(
        [...appState.currentTournament.players], 
        appState.currentTournament.rounds
      );
      
      // Update the tournament with the fresh stats
      appState.currentTournament.players = currentPlayers;
      
      // Sort players by score (using the freshly calculated stats)
      const sortedPlayers = [...currentPlayers]
        .sort((a, b) => (b.score || 0) - (a.score || 0));
      
      // Create simple player list
      sortedPlayers.forEach((player, index) => {
        const leaderboardItem = document.createElement('div');
        leaderboardItem.className = 'leaderboard-item';
        leaderboardItem.style.cssText = `
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 0.75rem;
          border-bottom: 1px solid var(--border-color);
          background-color: ${index === 0 ? 'rgba(106, 38, 205, 0.05)' : 'transparent'};
        `;
        
        leaderboardItem.innerHTML = `
          <div style="display: flex; align-items: center;">
            <div class="rank" style="min-width: 30px; min-height: 30px; display: flex; align-items: center; justify-content: center; background-color: ${index === 0 ? 'var(--primary-color)' : 'rgba(0, 0, 0, 0.05)'}; color: ${index === 0 ? 'white' : 'var(--text-color)'}; border-radius: 50%; margin-right: 10px; font-weight: bold; font-size: 0.9rem; flex-shrink: 0;">${index + 1}</div>
            <div style="flex: 1; min-width: 0;">
              <div style="font-weight: 600; font-size: 1rem; color: var(--text-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${player.name}</div>
              <div style="font-size: 0.7rem; color: var(--text-light); line-height: 1.3;">
                ${player.matchesPlayed || 0} matches
                <br>
                <span title="Win-Loss-Tie Record"><i class="fas fa-gamepad" style="margin-right: 2px;"></i> ${player.matchesWon || 0}-${player.matchesLost || 0}-${player.matchesTied || 0}</span>
              </div>
            </div>
          </div>
          <div style="text-align: right; flex-shrink: 0;">
            <div style="font-size: 1.3rem; font-weight: bold; color: var(--primary-color);">${player.score || 0}</div>
            <div style="font-size: 0.7rem; color: var(--text-light);">points</div>
          </div>
        `;
        
        leaderboardList.appendChild(leaderboardItem);
      });
    }
    
    // Function to edit player name
    function editPlayerName(playerId) {
      const player = appState.currentTournament.players.find(p => p.id === playerId);
      if (!player) return;
      
      const newName = prompt('Enter new name for player:', player.name);
      if (newName !== null && newName.trim() !== '') {
        player.name = newName.trim();
        saveTournamentData(appState.currentTournament);
        renderLeaderboard();
        
        // Also update rounds display if we're on that screen
        if (appState.currentScreen === 'roundsScreen') {
          renderMatches(appState.currentTournament.currentRound);
        }
      }
    }

    // Initialize a new tournament
    function initTournament(tournamentName, playerNames, playerCount, courtCount, tournamentType = 'mexicano') {
      console.log('Initializing tournament:', tournamentName);
      console.log('Player names:', playerNames);
      console.log('Player count:', playerCount, 'Court count:', courtCount);
      
      // Create player objects
      const players = playerNames.map((name, index) => ({
        id: `player-${index + 1}`,
        name: name,
        score: 0,
        matchesPlayed: 0,
        matchesWon: 0,
        matchesLost: 0,
        matchesTied: 0,
        pointsFor: 0,
        pointsAgainst: 0,
        restsCount: 0
      }));
      
      // Create tournament object with unique ID
      const uniqueId = Date.now().toString(36) + Math.random().toString(36).substring(2, 7);
      const tournament = {
        id: `tournament-${uniqueId}`,
        uniqueId: uniqueId,
        name: tournamentName,
        playerCount,
        courtCount,
        players,
        rounds: [],
        currentRound: 0,
        createdAt: Date.now(),
        updatedAt: Date.now(),
        status: 'active',
        type: tournamentType
      };
      
      // Generate first round
      const restingPlayers = getRestingPlayers(players, 0);
      const matches = generateMatches(players, 0, restingPlayers);
      
      tournament.rounds.push({
        roundNumber: 0,
        matches: matches,
        restingPlayers: restingPlayers
      });
      
      // Set as current tournament
      appState.currentTournament = tournament;
      
      // Save tournament data
      saveTournamentData(tournament);
      
      // Navigate to rounds screen
      showScreen('roundsScreen');
      
      // Render round tabs and matches
      renderRoundTabs();
      renderMatches(0);
      
      // Render leaderboard
      renderLeaderboard();
    }

    // Save players data to localStorage
    function savePlayersData() {
      console.log('Saving players data, total players:', appState.players.length);
      localStorage.setItem('padelAmericanoPlayers', JSON.stringify(appState.players));
      console.log('Players saved to localStorage');
      
      // Save to Firebase if available
      if (window.firebaseDB) {
        try {
          const playersRef = window.firebaseRef(window.firebaseDB, 'players');
          window.firebaseSet(playersRef, appState.players)
            .catch(error => console.warn('Failed to sync players to Firebase:', error));
        } catch (error) {
          console.warn('Error saving players to Firebase:', error);
        }
      }
    }
    
    // Load players from localStorage or Firebase
    function loadPlayersData() {
      console.log('Loading players data');
      // First try to load from localStorage
      const savedPlayers = JSON.parse(localStorage.getItem('padelAmericanoPlayers') || '[]');
      console.log('Loaded players from localStorage:', savedPlayers.length);
      appState.players = savedPlayers;
      
      // Then try to load from Firebase
      if (window.firebaseDB) {
        const playersRef = window.firebaseRef(window.firebaseDB, 'players');
        window.firebaseOnValue(playersRef, (snapshot) => {
          if (snapshot.exists()) {
            const firebasePlayers = snapshot.val();
            appState.players = firebasePlayers;
          }
          refreshPlayersList();
        }, (error) => {
          console.warn('Error loading players from Firebase:', error);
        });
      }
    }
    
    // Refresh the players list display
    function refreshPlayersList() {
      const playersList = document.getElementById('playersList');
      if (!playersList) return;
      
      playersList.innerHTML = '';
      
      if (appState.players.length === 0) {
        playersList.innerHTML = `
          <div class="empty-state" style="text-align: center; padding: 2rem 1rem;">
            <div style="width: 80px; height: 80px; margin: 0 auto 1.5rem; background-color: #f0f0f0; border-radius: 50%; display: flex; justify-content: center; align-items: center;">
              <i class="fas fa-user-plus" style="font-size: 2.5rem; color: var(--primary-color);"></i>
            </div>
            <h3 style="font-size: 1.4rem; margin-bottom: 1rem; color: var(--text-color);">No players yet</h3>
            <p style="color: var(--text-light); margin-bottom: 1.5rem;">Add your first player to get started</p>
          </div>
        `;
        return;
      }
      
      // Sort players by name
      const sortedPlayers = [...appState.players].sort((a, b) => a.name.localeCompare(b.name));
      
      // Create player items
      sortedPlayers.forEach(player => {
        const playerItem = document.createElement('div');
        playerItem.className = 'leaderboard-item';
        playerItem.dataset.playerId = player.id;
        
        playerItem.innerHTML = `
          <div class="player-name">${player.name}</div>
          <div style="display: flex; gap: 0.5rem;">
            <button class="btn btn-tiny btn-primary edit-player-btn" data-player-id="${player.id}">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-tiny btn-danger delete-player-btn" data-player-id="${player.id}">
              <i class="fas fa-trash-alt"></i>
            </button>
          </div>
        `;
        
        playersList.appendChild(playerItem);
        
        // Add event listeners to the buttons
        const editBtn = playerItem.querySelector('.edit-player-btn');
        const deleteBtn = playerItem.querySelector('.delete-player-btn');
        
        editBtn.addEventListener('click', () => {
          showPlayerModal('edit', player.id);
        });
        
        deleteBtn.addEventListener('click', () => {
          if (confirm(`Are you sure you want to delete ${player.name}?`)) {
            appState.players = appState.players.filter(p => p.id !== player.id);
            savePlayersData();
            refreshPlayersList();
            refreshRegisteredPlayersList();
          }
        });
      });
    }
    
    // Refresh the registered players list for tournament setup
    function refreshRegisteredPlayersList() {
      console.log('Refreshing registered players list, total players:', appState.players.length);
      const registeredPlayersList = document.getElementById('registeredPlayersList');
      if (!registeredPlayersList) {
        console.log('registeredPlayersList element not found');
        return;
      }
      
      registeredPlayersList.innerHTML = '';
      
      if (appState.players.length === 0) {
        console.log('No players to display');
        registeredPlayersList.innerHTML = `
          <div class="empty-state" style="text-align: center; padding: 2rem; grid-column: span 2;">
            <p>No saved players yet. Add players in the Players section.</p>
          </div>
        `;
        return;
      }
      
      // Sort players by name
      const sortedPlayers = [...appState.players].sort((a, b) => a.name.localeCompare(b.name));
      console.log('Sorted players:', sortedPlayers.map(p => p.name));
      
      // Create player items with checkboxes
      sortedPlayers.forEach(player => {
        const playerItem = document.createElement('div');
        playerItem.style.padding = '0.5rem';
        
        playerItem.innerHTML = `
          <label style="display: flex; align-items: center; cursor: pointer;">
            <input type="checkbox" data-player-id="${player.id}" style="margin-right: 0.5rem; min-width: 20px; min-height: 20px;">
            <span>${player.name}</span>
          </label>
        `;
        
        registeredPlayersList.appendChild(playerItem);
        console.log('Added player to list:', player.name, 'with ID:', player.id);
      });
      
      console.log('Finished refreshing player list');
    }
    
    // Show player modal for add/edit with animation
    function showPlayerModal(mode, playerId = null) {
      const modal = document.getElementById('playerModal');
      const modalContent = modal.querySelector('.modal-content');
      const titleEl = document.getElementById('playerModalTitle');
      const nameInput = document.getElementById('playerName');
      const skillLevelSelect = document.getElementById('playerSkillLevel');
      const notesTextarea = document.getElementById('playerNotes');
      
      // Clear form
      nameInput.value = '';
      skillLevelSelect.value = 'intermediate';
      notesTextarea.value = '';
      
      if (mode === 'edit' && playerId) {
        const player = appState.players.find(p => p.id === playerId);
        if (player) {
          titleEl.textContent = 'Edit Player';
          nameInput.value = player.name;
          skillLevelSelect.value = player.skillLevel || 'intermediate';
          notesTextarea.value = player.notes || '';
          document.getElementById('playerForm').dataset.playerId = playerId;
          document.getElementById('playerForm').dataset.mode = 'edit';
        }
      } else {
        titleEl.textContent = 'Add Player';
        document.getElementById('playerForm').dataset.playerId = '';
        document.getElementById('playerForm').dataset.mode = 'add';
      }
      
      // Show modal first without animation
      modal.style.display = 'flex';
      
      // Trigger animation after a small delay
      setTimeout(() => {
        modal.classList.add('active');
      }, 10);
      
      // Focus on the name input after animation completes
      setTimeout(() => {
        nameInput.focus();
      }, 350);
    }
    
    // Calculate global player rankings across all tournaments - ensuring data comes from valid rounds
    function calculateGlobalRankings() {
      const globalStats = {};
      
      // Initialize stats for all players
      appState.players.forEach(player => {
        globalStats[player.id] = {
          id: player.id,
          name: player.name,
          totalTournaments: 0,
          totalPoints: 0,
          totalMatches: 0,
          totalWins: 0,
          totalLosses: 0,
          totalTies: 0,
          totalPointsFor: 0,
          totalPointsAgainst: 0,
          pointsDifference: 0,
          totalRests: 0,
          averagePoints: 0,
          winRate: 0,
          skillLevel: player.skillLevel || 'intermediate',
          performanceRating: 0 // More intuitive name than "performanceScore"
        };
      });
      
      // Aggregate stats from all tournaments
      Object.values(appState.tournaments).forEach(tournament => {
        if (!tournament || !tournament.players || !tournament.players.length || !tournament.rounds) {
          return; // Skip invalid tournaments
        }
        
        // Recalculate each tournament's player stats to ensure accuracy
        const recalculatedPlayers = calculatePlayerStats([...tournament.players], tournament.rounds);
        
        // Now use the recalculated player data
        recalculatedPlayers.forEach(tournamentPlayer => {
          // First try to match by ID if it exists
          let globalPlayer = null;
          if (tournamentPlayer.id) {
            globalPlayer = appState.players.find(p => p.id === tournamentPlayer.id);
          }
          
          // Fallback to matching by name if needed
          if (!globalPlayer) {
            globalPlayer = appState.players.find(p => p.name === tournamentPlayer.name);
          }
          
          if (globalPlayer && globalStats[globalPlayer.id]) {
            const stats = globalStats[globalPlayer.id];
            stats.totalTournaments++;
            stats.totalPoints += tournamentPlayer.score || 0;
            stats.totalMatches += tournamentPlayer.matchesPlayed || 0;
            stats.totalWins += tournamentPlayer.matchesWon || 0;
            stats.totalLosses += tournamentPlayer.matchesLost || 0;
            stats.totalTies += tournamentPlayer.matchesTied || 0;
            stats.totalPointsFor += tournamentPlayer.pointsFor || 0;
            stats.totalPointsAgainst += tournamentPlayer.pointsAgainst || 0;
            stats.totalRests += tournamentPlayer.restsCount || 0;
          }
        });
      });
      
      // Calculate derived metrics with improved formulas
      Object.values(globalStats).forEach(stats => {
        if (stats.totalTournaments > 0) {
          // Calculate average points per tournament
          stats.averagePoints = Math.round(stats.totalPoints / stats.totalTournaments);
          
          // Calculate win rate percentage
          stats.winRate = stats.totalMatches > 0 ? Math.round((stats.totalWins / stats.totalMatches) * 100) : 0;
          
          // Calculate points difference (for/against)
          stats.pointsDifference = stats.totalPointsFor - stats.totalPointsAgainst;
          
          // Calculate performance rating using a more balanced formula
          // This formula gives weight to win percentage, points difference, and tournament experience
          const winFactor = stats.winRate / 100; // Convert percentage to factor between 0-1
          const tournamentExperience = Math.min(Math.log(stats.totalTournaments + 1), 2); // Cap experience factor
          const pointsImpact = Math.min(Math.abs(stats.pointsDifference) / 100, 1) * (stats.pointsDifference >= 0 ? 1 : -0.5);
          
          // Create a more balanced score (0-100 scale)
          stats.performanceRating = Math.round(
            (winFactor * 50) + // Win rate contributes up to 50 points
            (tournamentExperience * 15) + // Experience contributes up to 30 points
            (pointsImpact * 20) + // Points difference contributes up to 20 points
            (stats.averagePoints / 3) // Average points contributes up to ~15 points
          );
        }
      });
      
      // Filter and sort players who have played tournaments
      return Object.values(globalStats)
        .filter(stats => stats.totalTournaments > 0)
        .sort((a, b) => {
          // Primary: Performance rating
          if (b.performanceRating !== a.performanceRating) return b.performanceRating - a.performanceRating;
          // Secondary: Win rate
          if (b.winRate !== a.winRate) return b.winRate - a.winRate;
          // Tertiary: Average points
          if (b.averagePoints !== a.averagePoints) return b.averagePoints - a.averagePoints;
          // Quaternary: Points difference
          return b.pointsDifference - a.pointsDifference;
        });
    }
    
    // Render global rankings with improved display
    function renderGlobalRankings() {
      const globalRankingsList = document.getElementById('globalRankingsList');
      if (!globalRankingsList) return;
      
      const rankings = calculateGlobalRankings();
      globalRankingsList.innerHTML = '';
      
      if (rankings.length === 0) {
        globalRankingsList.innerHTML = `
          <div class="empty-state" style="text-align: center; padding: 2rem 1rem;">
            <div style="width: 80px; height: 80px; margin: 0 auto 1.5rem; background-color: #f0f0f0; border-radius: 50%; display: flex; justify-content: center; align-items: center;">
              <i class="fas fa-medal" style="font-size: 2.5rem; color: var(--primary-color);"></i>
            </div>
            <h3 style="font-size: 1.4rem; margin-bottom: 1rem; color: var(--text-color);">No rankings yet</h3>
            <p style="color: var(--text-light); margin-bottom: 1.5rem;">Play tournaments to build your global ranking</p>
          </div>
        `;
        return;
      }
      
      // Add player rankings using responsive cards instead of table
      rankings.forEach((stats, index) => {
        const rankingItem = document.createElement('div');
        rankingItem.className = 'global-ranking-card';
        rankingItem.style.cssText = `
          padding: 1rem;
          border-bottom: 1px solid var(--border-color);
          background-color: ${index === 0 ? 'rgba(106, 38, 205, 0.05)' : 'transparent'};
          width: 100%;
          box-sizing: border-box;
        `;
        
        // Determine skill level badge
        let skillBadge = '';
        if (stats.skillLevel) {
          const skillColors = {
            'beginner': '#6c757d',
            'intermediate': '#28a745',
            'advanced': '#dc3545',
            'pro': '#6A26CD'
          };
          
          const skillColor = skillColors[stats.skillLevel] || '#6c757d';
          skillBadge = `<span style="font-size: 0.7rem; background-color: ${skillColor}; color: white; padding: 0.1rem 0.3rem; border-radius: 4px; margin-left: 0.5rem;">${stats.skillLevel}</span>`;
        }
        
        // Format the goal difference
        const goalDiffFormatted = stats.pointsDifference > 0 ? `+${stats.pointsDifference}` : stats.pointsDifference;
        const goalDiffColor = stats.pointsDifference > 0 ? '#28a745' : (stats.pointsDifference < 0 ? '#dc3545' : '#6c757d');
        
        rankingItem.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <div style="display: flex; align-items: center;">
              <div class="rank" style="min-width: 35px; min-height: 35px; display: flex; align-items: center; justify-content: center; background-color: ${index === 0 ? 'var(--primary-color)' : 'rgba(0, 0, 0, 0.05)'}; color: ${index === 0 ? 'white' : 'var(--text-color)'}; border-radius: 50%; margin-right: 12px; font-weight: bold; font-size: 1rem;">${index + 1}</div>
              <div>
                <div style="font-weight: 600; font-size: 1.1rem; color: var(--text-color); display: flex; align-items: center;">
                  ${stats.name}${skillBadge}
                </div>
                <div style="font-size: 0.75rem; color: var(--text-light); margin-top: 0.25rem;">
                  <span title="Tournaments Played"><i class="fas fa-trophy" style="margin-right: 3px;"></i> ${stats.totalTournaments}</span>
                  <span style="margin-left: 0.75rem;" title="Win-Loss-Tie Record"><i class="fas fa-gamepad" style="margin-right: 3px;"></i> ${stats.totalWins}-${stats.totalLosses}-${stats.totalTies}</span>
                </div>
              </div>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem; width: 100%;">
            <div style="padding: 0.75rem; background-color: rgba(106, 38, 205, 0.1); border-radius: 8px; text-align: center;">
              <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary-color); margin-bottom: 0.25rem;">${stats.totalPoints}</div>
              <div style="font-size: 0.8rem; color: var(--text-color); font-weight: 500;">Total Points</div>
            </div>
            
            <div style="padding: 0.75rem; background-color: rgba(16, 185, 129, 0.1); border-radius: 8px; text-align: center;">
              <div style="font-size: 1.5rem; font-weight: bold; color: var(--success-color); margin-bottom: 0.25rem;">${stats.winRate}%</div>
              <div style="font-size: 0.8rem; color: var(--text-color); font-weight: 500;">Win Rate</div>
            </div>
            
            <div style="padding: 0.75rem; background-color: rgba(252, 211, 77, 0.1); border-radius: 8px; text-align: center;">
              <div style="font-size: 1.5rem; font-weight: bold; color: #F59E0B; margin-bottom: 0.25rem;">${stats.averagePoints}</div>
              <div style="font-size: 0.8rem; color: var(--text-color); font-weight: 500;">Avg Pts</div>
            </div>
          </div>
        `;
        
        globalRankingsList.appendChild(rankingItem);
      });
      

    }

    // Save player from modal with animated closure
    function savePlayer() {
      const form = document.getElementById('playerForm');
      const mode = form.dataset.mode;
      const playerId = form.dataset.playerId;
      const modal = document.getElementById('playerModal');
      
      const name = document.getElementById('playerName').value.trim();
      const skillLevel = document.getElementById('playerSkillLevel').value;
      const notes = document.getElementById('playerNotes').value.trim();
      
      if (!name) {
        alert('Please enter a player name');
        return;
      }
      
      if (mode === 'edit' && playerId) {
        // Update existing player
        const playerIndex = appState.players.findIndex(p => p.id === playerId);
        if (playerIndex !== -1) {
          appState.players[playerIndex].name = name;
          appState.players[playerIndex].skillLevel = skillLevel;
          appState.players[playerIndex].notes = notes;
        }
      } else {
        // Add new player
        const newPlayer = {
          id: `player-${Date.now()}`,
          name,
          skillLevel,
          notes,
          createdAt: Date.now(),
          statistics: {
            totalGames: 0,
            wins: 0,
            losses: 0,
            winPercentage: 0
          }
        };
        
        appState.players.push(newPlayer);
      }
      
      // Save players and refresh displays
      savePlayersData();
      refreshPlayersList();
      refreshRegisteredPlayersList();
      
      // Close modal with animation
      modal.classList.remove('active');
      
      // Hide modal completely after animation completes
      setTimeout(() => {
        modal.style.display = 'none';
      }, 300);
    }
    
    // Save tournament data to Firebase and localStorage with real-time sync
    function saveTournamentData(tournament) {
      tournament.updatedAt = Date.now();
      
      // Recalculate player stats before saving to ensure consistency
      tournament.players = calculatePlayerStats([...tournament.players], tournament.rounds);
      
      // Clean up any empty or invalid rounds
      if (tournament.rounds) {
        tournament.rounds = tournament.rounds.filter(round => 
          round && round.matches && round.matches.length > 0
        );
        
        // Renumber rounds to ensure consistency
        tournament.rounds.forEach((round, index) => {
          round.roundNumber = index;
        });
        
        // Make sure currentRound is within valid bounds
        if (tournament.currentRound >= tournament.rounds.length) {
          tournament.currentRound = Math.max(0, tournament.rounds.length - 1);
        }
      }
      
      // Save to localStorage first (always works)
      const savedTournaments = JSON.parse(localStorage.getItem('padelAmericanoTournaments') || '{}');
      savedTournaments[tournament.id] = tournament;
      localStorage.setItem('padelAmericanoTournaments', JSON.stringify(savedTournaments));
      
      // Save to Firebase if available
      if (window.firebaseDB) {
        const tournamentRef = window.firebaseRef(window.firebaseDB, `tournaments/${tournament.id}`);
        window.firebaseSet(tournamentRef, tournament)
          .then(() => {
            console.log('✅ Tournament synced to Firebase RTDB');
            updateSyncStatus(true);
          })
          .catch(error => {
            console.warn('❌ Firebase sync failed:', error);
            console.log('📱 Data saved locally only');
            updateSyncStatus(false);
          });
      } else {
        console.log('📱 Firebase not available, data saved locally only');
      }
    }

    // Load all tournaments from localStorage and Firebase with priority logic
    function loadTournaments() {
      // Check if we're online and have Firebase available
      const isOnlineWithFirebase = window.firebaseDB && window.isFirebaseOnline && navigator.onLine;
      
      if (isOnlineWithFirebase) {
        // When online with Firebase: Load only from Firebase (prioritize cloud data)
        console.log('🌐 Online mode: Loading tournaments from Firebase only');
        appState.tournaments = {}; // Clear local tournaments when online
        
        const tournamentsRef = window.firebaseRef(window.firebaseDB, 'tournaments');
        window.firebaseOnValue(tournamentsRef, (snapshot) => {
          try {
            if (snapshot.exists()) {
              const firebaseTournaments = snapshot.val();
              
              // Clean up and recalculate tournament data on load
              Object.values(firebaseTournaments).forEach(tournament => {
                if (tournament && tournament.players && tournament.rounds) {
                  tournament.players = calculatePlayerStats([...tournament.players], tournament.rounds);
                }
              });
              
              appState.tournaments = firebaseTournaments;
              
              // Save to localStorage as backup
              localStorage.setItem('padelAmericanoTournaments', JSON.stringify(firebaseTournaments));
              
              // Render tournament list
              renderTournamentList();
              
              // Update current tournament if it was modified
              if (appState.currentTournament && appState.tournaments[appState.currentTournament.id]) {
                const updatedTournament = appState.tournaments[appState.currentTournament.id];
                if (updatedTournament.updatedAt > appState.currentTournament.updatedAt) {
                  appState.currentTournament = updatedTournament;
                  if (appState.currentScreen === 'roundsScreen') {
                    renderRoundTabs();
                    renderMatches(appState.currentTournament.currentRound || 0);
                  }
                  if (appState.currentScreen === 'leaderboardScreen') {
                    renderLeaderboard();
                  }
                }
              }
              
              console.log('🔄 Real-time sync: Tournaments loaded from Firebase');
            } else {
              // No tournaments in Firebase
              appState.tournaments = {};
              renderTournamentList();
            }
          } catch (error) {
            console.warn('Firebase sync error:', error);
            fallbackToLocalStorage();
          }
        }, (error) => {
          console.warn('Firebase listener error:', error);
          updateSyncStatus(false);
          fallbackToLocalStorage();
        });
      } else {
        // When offline or Firebase not available: Use localStorage
        fallbackToLocalStorage();
      }
    }
    
    // Fallback function to load from localStorage
    function fallbackToLocalStorage() {
      console.log('📱 Offline mode: Loading tournaments from localStorage');
      const savedTournaments = JSON.parse(localStorage.getItem('padelAmericanoTournaments') || '{}');
      
      // Clean up and recalculate tournament data on load from localStorage too
      Object.values(savedTournaments).forEach(tournament => {
        if (tournament && tournament.players && tournament.rounds) {
          tournament.players = calculatePlayerStats([...tournament.players], tournament.rounds);
        }
      });
      
      appState.tournaments = savedTournaments;
      renderTournamentList();
    }

    // Render tournament list
    function renderTournamentList() {
      const tournamentsList = document.getElementById('tournamentsList');
      if (!tournamentsList) {
        console.error('Tournament list container not found');
        return;
      }
      
      tournamentsList.innerHTML = '';
      
      const tournaments = Object.values(appState.tournaments);
      
      if (tournaments.length === 0) {
        tournamentsList.innerHTML = `
          <div class="empty-state" style="text-align: center; padding: 2rem 1.5rem;">
            <div style="width: 80px; height: 80px; margin: 0 auto 1.5rem; background-color: #f0f0f0; border-radius: 50%; display: flex; justify-content: center; align-items: center;">
              <i class="fas fa-trophy" style="font-size: 2.5rem; color: var(--primary-color);"></i>
            </div>
            <h3 style="font-size: 1.4rem; margin-bottom: 1rem; color: var(--text-color);">No tournaments yet</h3>
            <p style="color: var(--text-light); margin-bottom: 1rem;">Create your first tournament to get started!</p>
          </div>
        `;
        return;
      }
      
      // Sort tournaments by creation date (newest first)
      tournaments.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
      
      tournaments.forEach(tournament => {
        const tournamentItem = document.createElement('div');
        tournamentItem.className = 'tournament-item';
        tournamentItem.dataset.tournamentId = tournament.id;
        
        // Add specific styles for better clickability
        tournamentItem.style.position = 'relative';
        tournamentItem.style.zIndex = '10';
        
        tournamentItem.innerHTML = `
          <div class="tournament-info">
            <div class="tournament-name">${tournament.name}</div>
          </div>
          <div class="tournament-meta">
            <div class="tournament-meta-item">
              <i class="fas fa-tag"></i>
              ${tournament.type || 'Mexicano'}
            </div>
            <div class="tournament-meta-item">
              <i class="fas fa-users"></i>
              ${tournament.playerCount || tournament.players?.length || 0} players
            </div>
          </div>
        `;
        
        // Make the entire item a clickable button for better tap experience
        tournamentItem.setAttribute('role', 'button');
        tournamentItem.setAttribute('tabindex', '0');
        tournamentItem.setAttribute('aria-label', `Open ${tournament.name} tournament`);
        
        // Direct click handler using the tournament ID directly instead of accessing dataset
        const tournamentId = tournament.id;
        tournamentItem.onclick = function(e) {
          try {
            e.preventDefault();
            e.stopPropagation();
            console.log('Tournament item clicked directly:', tournamentId);
            loadTournament(tournamentId);
            return false;
          } catch (error) {
            console.error('Error handling tournament item click:', error);
            alert('Error loading tournament. Please try again.');
          }
        };
        
        // Also add keyboard accessibility
        tournamentItem.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            try {
              console.log('Tournament item activated via keyboard:', tournamentId);
              loadTournament(tournamentId);
            } catch (error) {
              console.error('Error handling tournament keyboard activation:', error);
              alert('Error loading tournament. Please try again.');
            }
          }
        });
        
        tournamentsList.appendChild(tournamentItem);
      });
    }

    // Load a specific tournament
    function loadTournament(tournamentId) {
      const tournament = appState.tournaments[tournamentId];
      if (tournament) {
        console.log('Loading tournament:', tournament.name);
        
        // Recalculate player stats to ensure accurate scores based on current rounds
        if (tournament.players && tournament.rounds) {
          tournament.players = calculatePlayerStats([...tournament.players], tournament.rounds);
          console.log('Recalculated player stats for tournament:', tournament.name);
        }
        
        appState.currentTournament = tournament;
        
        try {
          // Navigate to rounds screen
          showScreen('roundsScreen');
          
          // Render round tabs and matches
          renderRoundTabs();
          renderMatches(tournament.currentRound || 0);
          
          // Render leaderboard with the recalculated stats
          renderLeaderboard();
          
          // Save the tournament with updated stats to ensure consistency
          saveTournamentData(tournament);
        } catch (error) {
          console.error('Error loading tournament:', error);
          // Fallback - if there's an error, reset and show tournament list
          alert('Error loading tournament. Please try again.');
          appState.currentTournament = null;
          showScreen('tournamentListScreen');
        }
      } else {
        console.error('Tournament not found:', tournamentId);
        alert('Tournament not found');
      }
    }

    // Delete a tournament with admin pin verification
    function deleteTournament(tournamentId) {
      // Ask for admin pin before proceeding
      const adminPin = prompt('Enter admin PIN to delete this tournament:');
      
      // Check if pin is correct (PIN: 0704)
      if (adminPin === '0704') {
        if (confirm('PIN verified. Are you sure you want to delete this tournament? This action cannot be undone.')) {
          // Remove from localStorage
          delete appState.tournaments[tournamentId];
          localStorage.setItem('padelAmericanoTournaments', JSON.stringify(appState.tournaments));
          
          // Remove from Firebase if available
          if (window.firebaseDB && window.isFirebaseOnline) {
            const tournamentRef = window.firebaseRef(window.firebaseDB, `tournaments/${tournamentId}`);
            window.firebaseSet(tournamentRef, null)
              .then(() => {
                console.log('Tournament deleted from Firebase');
              })
              .catch(error => {
                console.error('Error deleting from Firebase:', error);
              });
          }
          
          // Re-render tournament list
          renderTournamentList();
          
          // If this was the current tournament, go back to tournament list
          if (appState.currentTournament && appState.currentTournament.id === tournamentId) {
            appState.currentTournament = null;
            showScreen('tournamentListScreen');
          }
        }
      } else {
        alert('Incorrect PIN. Tournament deletion canceled.');
      }
    }

    // Export functions
    function exportToPDF() {
      // Create a new window with printable content
      const printWindow = window.open('', '_blank');
      const tournament = appState.currentTournament;
      
      // Calculate comprehensive player stats
      const playersWithStats = [...tournament.players].sort((a, b) => {
        if (b.score !== a.score) return b.score - a.score;
        const aDiff = a.pointsFor - a.pointsAgainst;
        const bDiff = b.pointsFor - b.pointsAgainst;
        if (bDiff !== aDiff) return bDiff - aDiff;
        return b.pointsFor - a.pointsFor;
      });
      
      // Generate round details for PDF
      const roundDetails = tournament.rounds.map((round, roundIndex) => {
        let roundHtml = `
          <div class="round-section">
            <h3>Round #${roundIndex + 1}</h3>
        `;
        
        // Show resting players if any
        if (round.restingPlayers && round.restingPlayers.length > 0) {
          const restingPlayerNames = round.restingPlayers.map(playerId => 
            tournament.players.find(p => p.id === playerId)?.name || 'Unknown'
          );
          roundHtml += `
            <div class="resting-players">
              <strong>Resting:</strong> ${restingPlayerNames.join(', ')} (+10 bonus points)
            </div>
          `;
        }
        
        // Show matches
        round.matches.forEach((match, matchIndex) => {
          const teamAPlayers = match.teamA.map(playerId => 
            tournament.players.find(p => p.id === playerId)?.name || 'Unknown'
          );
          const teamBPlayers = match.teamB.map(playerId => 
            tournament.players.find(p => p.id === playerId)?.name || 'Unknown'
          );
          
          roundHtml += `
            <div class="match-result">
              <h4>Court ${match.courtNumber}</h4>
              <div class="match-teams">
                <div class="team">
                  <div class="team-players">${teamAPlayers.join(' & ')}</div>
                  <div class="score ${match.scoreA > match.scoreB ? 'winner' : ''}">${match.completed ? match.scoreA : '-'}</div>
                </div>
                <div class="vs">vs</div>
                <div class="team">
                  <div class="team-players">${teamBPlayers.join(' & ')}</div>
                  <div class="score ${match.scoreB > match.scoreA ? 'winner' : ''}">${match.completed ? match.scoreB : '-'}</div>
                </div>
              </div>
              ${match.completed ? `<div class="match-status">Final Score: ${match.scoreA} - ${match.scoreB}</div>` : '<div class="match-status">Not completed</div>'}
            </div>
          `;
        });
        
        roundHtml += '</div>';
        return roundHtml;
      }).join('');
      
      const printContent = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>${tournament.name} - Complete Results</title>
          <style>
            body { 
              font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
              margin: 20px; 
              color: #333;
              line-height: 1.4;
            }
            .header { 
              text-align: center; 
              margin-bottom: 40px; 
              border-bottom: 3px solid #8B5CF6;
              padding-bottom: 20px;
            }
            .header h1 {
              font-size: 2.5em;
              margin: 0;
              color: #8B5CF6;
              font-weight: bold;
            }
            .tournament-info { 
              margin-bottom: 30px; 
              background: #f8f9fa;
              padding: 15px;
              border-radius: 8px;
              display: flex;
              justify-content: space-around;
              flex-wrap: wrap;
            }
            .tournament-info div {
              margin: 5px 15px;
            }
            .section-title {
              font-size: 1.8em;
              color: #8B5CF6;
              margin: 30px 0 15px 0;
              border-bottom: 2px solid #8B5CF6;
              padding-bottom: 5px;
            }
            .leaderboard { 
              width: 100%; 
              border-collapse: collapse; 
              margin-bottom: 40px;
              box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
            .leaderboard th, .leaderboard td { 
              border: 1px solid #ddd; 
              padding: 12px 8px; 
              text-align: center; 
            }
            .leaderboard th { 
              background-color: #8B5CF6; 
              color: white; 
              font-weight: bold;
            }
            .leaderboard tr:nth-child(even) {
              background-color: #f8f9fa;
            }
            .leaderboard tr:hover {
              background-color: #e9ecef;
            }
            .rank { 
              text-align: center; 
              font-weight: bold; 
              font-size: 1.1em;
            }
            .player-name {
              text-align: left;
              font-weight: 600;
            }
            .round-section {
              margin-bottom: 30px;
              border: 1px solid #e9ecef;
              border-radius: 8px;
              padding: 20px;
              background: #fff;
            }
            .round-section h3 {
              margin: 0 0 15px 0;
              color: #8B5CF6;
              font-size: 1.4em;
            }
            .resting-players {
              background: #fff3cd;
              border: 1px solid #ffeaa7;
              padding: 10px;
              border-radius: 5px;
              margin-bottom: 15px;
              text-align: center;
            }
            .match-result {
              margin-bottom: 20px;
              border: 1px solid #dee2e6;
              border-radius: 5px;
              padding: 15px;
              background: #f8f9fa;
            }
            .match-result h4 {
              margin: 0 0 10px 0;
              color: #495057;
              text-align: center;
            }
            .match-teams {
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 10px;
            }
            .team {
              flex: 1;
              text-align: center;
            }
            .team-players {
              font-weight: 600;
              margin-bottom: 5px;
            }
            .score {
              font-size: 2em;
              font-weight: bold;
              color: #6c757d;
            }
            .score.winner {
              color: #28a745;
            }
            .vs {
              margin: 0 20px;
              font-weight: bold;
              color: #6c757d;
            }
            .match-status {
              text-align: center;
              font-size: 0.9em;
              color: #6c757d;
              font-style: italic;
            }
            @media print { 
              .no-print { display: none; }
              body { margin: 10px; }
              .round-section { break-inside: avoid; }
            }
            @page {
              margin: 1.5cm;
            }
          </style>
        </head>
        <body>
          <div class="header">
            <h1>${tournament.name}</h1>
            <p style="font-size: 1.2em; color: #6c757d; margin: 10px 0;">Complete Tournament Results</p>
          </div>
          
          <div class="tournament-info">
            <div><strong>Type:</strong> ${tournament.type || 'Mexicano'}</div>
            <div><strong>Players:</strong> ${tournament.playerCount}</div>
            <div><strong>Courts:</strong> ${tournament.courtCount}</div>
            <div><strong>Rounds:</strong> ${tournament.rounds.length}</div>
            <div><strong>Date:</strong> ${new Date(tournament.createdAt).toLocaleDateString()}</div>
            <div><strong>Tournament Type:</strong> Mexicano (Americano)</div>
          </div>
          
          <h2 class="section-title">Final Leaderboard</h2>
          <table class="leaderboard">
            <thead>
              <tr>
                <th style="width: 60px;">Rank</th>
                <th style="width: 200px;">Player</th>
                <th style="width: 100px;">W-L-T</th>
                <th style="width: 100px;">Goal Diff</th>
                <th style="width: 100px;">Points</th>
                <th style="width: 80px;">Rests</th>
              </tr>
            </thead>
            <tbody>
              ${playersWithStats.map((player, index) => {
                const pointsDiff = player.pointsFor - player.pointsAgainst;
                return `
                  <tr>
                    <td class="rank">${index + 1}.</td>
                    <td class="player-name">${player.name}</td>
                    <td>${player.matchesWon}-${player.matchesLost}-${player.matchesTied}</td>
                    <td>${pointsDiff >= 0 ? '+' : ''}${pointsDiff}</td>
                    <td><strong>${player.score}</strong></td>
                    <td>${player.restsCount || 0}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
          
          <h2 class="section-title">Round by Round Results</h2>
          ${roundDetails}
          
          <div class="no-print" style="margin-top: 40px; text-align: center; padding: 20px; border-top: 2px solid #dee2e6;">
            <button onclick="window.print()" style="background: #8B5CF6; color: white; border: none; padding: 15px 30px; border-radius: 5px; font-size: 16px; margin: 10px; cursor: pointer;">Print PDF</button>
            <button onclick="window.close()" style="background: #6c757d; color: white; border: none; padding: 15px 30px; border-radius: 5px; font-size: 16px; margin: 10px; cursor: pointer;">Close</button>
          </div>
          
          <div style="margin-top: 40px; text-align: center; color: #6c757d; font-size: 0.9em; border-top: 1px solid #dee2e6; padding-top: 20px;">
            Generated by Padel Management Tournament System<br>
            ${new Date().toLocaleString()}
          </div>
        </body>
        </html>
      `;
      
      printWindow.document.write(printContent);
      printWindow.document.close();
    }

    function exportToPNG() {
      const canvas = document.getElementById('exportCanvas');
      const ctx = canvas.getContext('2d');
      
      // Set canvas size
      canvas.width = 800;
      canvas.height = 600;
      
      // Clear canvas
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Draw header
      ctx.fillStyle = '#8B5CF6';
      ctx.fillRect(0, 0, canvas.width, 80);
      
      ctx.fillStyle = '#ffffff';
      ctx.font = 'bold 24px Arial';
      ctx.textAlign = 'center';
      ctx.fillText(appState.currentTournament.name, canvas.width / 2, 35);
      ctx.font = '16px Arial';
      ctx.fillText('Final Results', canvas.width / 2, 60);
      
      // Draw leaderboard
      const sortedPlayers = [...appState.currentTournament.players].sort((a, b) => {
        if (b.score !== a.score) return b.score - a.score;
        const aDiff = a.pointsFor - a.pointsAgainst;
        const bDiff = b.pointsFor - b.pointsAgainst;
        if (bDiff !== aDiff) return bDiff - aDiff;
        return b.pointsFor - a.pointsFor;
      });
      
      ctx.fillStyle = '#1F2937';
      ctx.font = 'bold 16px Arial';
      ctx.textAlign = 'left';
      ctx.fillText('Rank', 50, 120);
      ctx.fillText('Player', 150, 120);
      ctx.fillText('Points', 400, 120);
      ctx.fillText('Matches', 500, 120);
      ctx.fillText('Goal Diff', 650, 120);
      
      // Draw line under header
      ctx.strokeStyle = '#E5E7EB';
      ctx.beginPath();
      ctx.moveTo(50, 130);
      ctx.lineTo(750, 130);
      ctx.stroke();
      
      // Draw player data
      ctx.font = '14px Arial';
      sortedPlayers.forEach((player, index) => {
        const y = 160 + (index * 30);
        const pointsDiff = player.pointsFor - player.pointsAgainst;
        
        ctx.fillText((index + 1).toString(), 50, y);
        ctx.fillText(player.name, 150, y);
        ctx.fillText(player.score.toString(), 400, y);
        ctx.fillText(`${player.matchesWon}W ${player.matchesLost}L ${player.matchesTied}T`, 500, y);
        ctx.fillText(`${pointsDiff >= 0 ? '+' : ''}${pointsDiff}`, 650, y);
      });
      
      // Convert to blob and download
      canvas.toBlob(function(blob) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${appState.currentTournament.name}-results.png`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      });
    }

    // Toggle sidebar menu with consistent animation
    function toggleSidebar() {
      try {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        
        if (sidebar && overlay) {
          // Add animation classes
          if (sidebar.classList.contains('active')) {
            // Closing animation
            sidebar.style.transition = 'left 0.3s ease';
            overlay.style.transition = 'opacity 0.3s ease';
            overlay.style.opacity = '0';
            
            // First animate, then remove active class
            setTimeout(() => {
              sidebar.classList.remove('active');
              overlay.classList.remove('active');
            }, 300);
          } else {
            // Opening animation
            sidebar.style.transition = 'left 0.3s ease';
            sidebar.classList.add('active');
            overlay.classList.add('active');
            overlay.style.transition = 'opacity 0.3s ease';
            overlay.style.opacity = '1';
          }
        } else {
          console.error('Sidebar or overlay element not found');
        }
      } catch (error) {
        console.error('Error toggling sidebar:', error);
      }
    }
    
    // Toggle dark mode
    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      const isDarkMode = document.body.classList.contains('dark-mode');
      localStorage.setItem('darkMode', isDarkMode);
      
      // Update toggle switch state
      const darkModeToggle = document.getElementById('darkModeToggle');
      if (darkModeToggle) {
        darkModeToggle.checked = isDarkMode;
      }
      
      // Force repaint to ensure all elements are updated
      document.body.style.display = 'none';
      document.body.offsetHeight; // Trigger reflow
      document.body.style.display = '';
    }
    
    // Toggle app info section
    function toggleAppInfo() {
      const appInfoSection = document.getElementById('appInfoSection');
      appInfoSection.style.display = appInfoSection.style.display === 'none' ? 'block' : 'none';
    }

    // Function to click on a tournament item (helper function for debugging)
    function clickTournamentItem(tournamentId) {
      try {
        const tournamentItem = document.querySelector(`.tournament-item[data-tournament-id="${tournamentId}"]`);
        if (tournamentItem) {
          tournamentItem.click();
        } else {
          console.error('Tournament item not found:', tournamentId);
          // Fallback to direct loading
          loadTournament(tournamentId);
        }
      } catch (error) {
        console.error('Error clicking tournament item:', error);
        // Fallback to direct loading
        loadTournament(tournamentId);
      }
    }
    
    // Event Listeners
    document.addEventListener('DOMContentLoaded', function() {
      // Apply dark mode setting from localStorage
      if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
        const darkModeToggle = document.getElementById('darkModeToggle');
        if (darkModeToggle) {
          darkModeToggle.checked = true;
        }
      }
      
      // Add window resize handler for scroll prevention
      window.addEventListener('resize', function() {
        checkAndPreventScrolling(appState.currentScreen);
      });
      
      // Ensure bottom navigation is hidden on initial load
      updateNavigation('tournamentListScreen');
      
      // Add tournament delete button handler with animation feedback
      document.getElementById('tournamentDeleteBtn').addEventListener('click', function() {
        // Add animation feedback
        this.style.transform = 'scale(0.95)';
        setTimeout(() => {
          this.style.transform = 'none';
          if (appState.currentTournament) {
            deleteTournament(appState.currentTournament.id);
          }
        }, 100);
      });
      
      // Back button - keep the listener but change the behavior to use sidebar
      document.getElementById('backBtn').addEventListener('click', function() {
        // Instead of direct navigation, just toggle the sidebar menu
        toggleSidebar();
      });

      // Menu button - toggle sidebar
      document.getElementById('menuBtn').addEventListener('click', toggleSidebar);
      
      // Close sidebar button
      document.getElementById('closeSidebarBtn').addEventListener('click', toggleSidebar);
      
      // Overlay click to close sidebar
      document.getElementById('overlay').addEventListener('click', toggleSidebar);
      
      // Sidebar menu items with animation feedback
      document.querySelectorAll('.sidebar-menu-item').forEach(item => {
        item.addEventListener('click', function() {
          const page = this.dataset.page;
          
          // Add animation feedback
          this.style.transform = 'scale(0.95)';
          
          // Update active menu item
          document.querySelectorAll('.sidebar-menu-item').forEach(menuItem => {
            menuItem.classList.remove('active');
          });
          this.classList.add('active');
          
          // Slight delay for visual feedback before transition
          setTimeout(() => {
            this.style.transform = 'none';
            
            // Show selected screen
            if (page === 'tournaments') {
              showScreen('tournamentListScreen');
            } else if (page === 'settings') {
              showScreen('settingsScreen');
            } else if (page === 'players') {
              showScreen('playersScreen');
              refreshPlayersList();
            } else if (page === 'rankings') {
              showScreen('rankingsScreen');
              // Improved global rankings with a delay to ensure screen transition is complete
              setTimeout(() => {
                console.log("Refreshing global rankings...");
                renderGlobalRankings();
              }, 300);
            }
            
            // Close sidebar
            toggleSidebar();
          }, 100);
        });
      });

      // Dark mode toggle (removed)
      
      // Download source code button
      const downloadSourceBtn = document.getElementById('downloadSourceBtn');
      if (downloadSourceBtn) {
        downloadSourceBtn.addEventListener('click', function() {
          console.log('Download source code button clicked');
          downloadSourceBtn.disabled = true;
          downloadSourceBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Downloading...';
          
          // Start the download process
          downloadSourceCode().finally(() => {
            // Re-enable the button after download completes or fails
            setTimeout(() => {
              downloadSourceBtn.disabled = false;
              downloadSourceBtn.innerHTML = '<i class="fas fa-download"></i> Download';
            }, 2000);
          });
        });
      }
      
      // App info toggle
      document.getElementById('showAppInfoBtn').addEventListener('click', toggleAppInfo);

      // New Tournament Button
      // New Tournament Button with enhanced error handling and direct navigation
      const newTournamentBtn = document.getElementById('newTournamentBtn');
      if (newTournamentBtn) {
        // Remove any existing event listeners
        newTournamentBtn.replaceWith(newTournamentBtn.cloneNode(true));
        
        // Get the fresh reference after replacement
        const freshNewTournamentBtn = document.getElementById('newTournamentBtn');
        
        // Add the new event listener
        freshNewTournamentBtn.addEventListener('click', function(e) {
          try {
            e.preventDefault();
            e.stopPropagation();
            console.log('New Tournament button clicked - direct handler');
            
            // Prepare setup screen
            updatePlayerCountDisplay();
            generatePlayerInputs(4);
            
            // Reset tournament type selection and show the type selection card
            const typeCard = document.getElementById('tournamentTypeCard');
            const detailsCard = document.getElementById('tournamentDetailsCard');
            
            if (typeCard && detailsCard) {
              typeCard.style.display = 'block';
              detailsCard.style.display = 'none';
            } else {
              console.error('Tournament cards not found');
            }
            
            // Navigate to setup screen
            showScreen('setupScreen');
            
            // Reset tournament name field
            document.getElementById('tournamentName').value = '';
            
            // Reset any previously selected tournament type
            const typeOptions = document.querySelectorAll('.tournament-type-option');
            typeOptions.forEach(option => {
              option.style.borderColor = '#e5e7eb';
            });
            
            // Default to Mexicano for new tournament
            appState.tournamentType = 'mexicano';
          } catch (error) {
            console.error('Error handling new tournament click:', error);
            alert('An error occurred while creating a new tournament. Please try again.');
          }
        });
      } else {
        console.error('New Tournament button not found');
      }

      // Player count range slider
      document.getElementById('playerCount').addEventListener('input', function() {
        updatePlayerCountDisplay();
        generatePlayerInputs(parseInt(this.value));
      });
      
      // Tournament Type Selection
      const typeOptions = document.querySelectorAll('.tournament-type-option');
      typeOptions.forEach(option => {
        option.addEventListener('click', function() {
          // Reset all options
          typeOptions.forEach(opt => {
            opt.style.borderColor = '#e5e7eb';
          });
          
          // Select this option
          this.style.borderColor = 'var(--primary-color)';
          appState.tournamentType = this.getAttribute('data-type');
        });
      });
      
      // Setup back button
      document.getElementById('setupBackBtn').addEventListener('click', function() {
        showScreen('tournamentListScreen');
      });
      
      // Continue to setup button
      document.getElementById('continueSetupBtn').addEventListener('click', function() {
        document.getElementById('tournamentTypeCard').style.display = 'none';
        document.getElementById('tournamentDetailsCard').style.display = 'block';
        document.getElementById('tournamentTypeLabel').textContent = 
          appState.tournamentType === 'mexicano' ? 'Mexicano' : 'Americano';
        
        console.log('Continue button clicked, setting up player selection');
        // Make sure players are loaded before refreshing the list
        if (appState.players.length === 0) {
          console.log('No players found on continue, loading players data');
          loadPlayersData();
        }
        
        // Set up player selection
        refreshRegisteredPlayersList();
        console.log('Player selection set up, players count:', appState.players.length);
        
        // Force display of existing players
        setTimeout(() => {
          const existingPlayersTab = document.getElementById('existingPlayersTab');
          const newPlayersTab = document.getElementById('newPlayersTab');
          const existingPlayersPanel = document.getElementById('existingPlayersPanel');
          const newPlayersPanel = document.getElementById('newPlayersPanel');
          
          existingPlayersTab.classList.add('active');
          newPlayersTab.classList.remove('active');
          existingPlayersTab.style.borderBottom = '2px solid var(--primary-color)';
          newPlayersTab.style.borderBottom = '2px solid #e5e7eb';
          existingPlayersPanel.style.display = 'block';
          newPlayersPanel.style.display = 'none';
          
          console.log('Forced display of existing players tab');
          refreshRegisteredPlayersList();
        }, 200);
      });
      
      // Back to type selection button
      document.getElementById('backToTypeBtn').addEventListener('click', function() {
        document.getElementById('tournamentTypeCard').style.display = 'block';
        document.getElementById('tournamentDetailsCard').style.display = 'none';
      });
      
      // Player Selection Tabs
      document.getElementById('existingPlayersTab').addEventListener('click', function() {
        this.classList.add('active');
        document.getElementById('newPlayersTab').classList.remove('active');
        this.style.borderBottom = '2px solid var(--primary-color)';
        document.getElementById('newPlayersTab').style.borderBottom = '2px solid #e5e7eb';
        document.getElementById('existingPlayersPanel').style.display = 'block';
        document.getElementById('newPlayersPanel').style.display = 'none';
        refreshRegisteredPlayersList();
      });
      
      document.getElementById('newPlayersTab').addEventListener('click', function() {
        this.classList.add('active');
        document.getElementById('existingPlayersTab').classList.remove('active');
        this.style.borderBottom = '2px solid var(--primary-color)';
        document.getElementById('existingPlayersTab').style.borderBottom = '2px solid #e5e7eb';
        document.getElementById('existingPlayersPanel').style.display = 'none';
        document.getElementById('newPlayersPanel').style.display = 'block';
      });
      
      // Add Player button
      document.getElementById('addPlayerBtn').addEventListener('click', function() {
        showPlayerModal('add');
      });
      
      // Additional click handler for Start Tournament button (in case form submission has issues)
      document.getElementById('startTournamentBtn').addEventListener('click', function(e) {
        // Prevent default form submission to handle it through our custom code
        e.preventDefault();
        
        // Prevent multiple clicks
        if (this.disabled) {
          return;
        }
        
        console.log('Start Tournament button clicked, submitting form');
        // Manually trigger the form submission event handler
        document.getElementById('setupForm').dispatchEvent(new Event('submit'));
        
        // Reset the button state after a short delay to allow for error cases
        setTimeout(() => {
          this.disabled = false;
        }, 500);
      });
      
      // Player modal form submission
      document.getElementById('playerForm').addEventListener('submit', function(e) {
        e.preventDefault();
        savePlayer();
      });
      
      // Close player modal with animation
      document.getElementById('closePlayerModal').addEventListener('click', function() {
        const modal = document.getElementById('playerModal');
        // First remove the active class to trigger the fade-out animation
        modal.classList.remove('active');
        
        // After animation completes, hide the modal completely
        setTimeout(() => {
          modal.style.display = 'none';
        }, 300);
      });
      
      // Setup Form Submit
      document.getElementById('setupForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const tournamentName = document.getElementById('tournamentName').value.trim() || 'Padel Tournament';
        const playerCount = parseInt(document.getElementById('playerCount').value, 10);
        const courtCount = parseInt(document.getElementById('courtCount').value, 10);
        
        console.log('Tournament setup form submitted:', { tournamentName, playerCount, courtCount });
        
        // Collect player names
        const playerNames = [];
        const existingPlayersPanel = document.getElementById('existingPlayersPanel');
        
        // Check which player selection mode we're in by looking at active tab
        const existingPlayersTab = document.getElementById('existingPlayersTab');
        const isExistingPlayersActive = existingPlayersTab.classList.contains('active');
        
        console.log('Existing players tab active:', isExistingPlayersActive);
        
        if (isExistingPlayersActive) {
          // Get checked players from existing players
          const checkedPlayers = document.querySelectorAll('#registeredPlayersList input[type="checkbox"]:checked');
          console.log('Checked players:', checkedPlayers.length);
          
          checkedPlayers.forEach(checkbox => {
            const playerId = checkbox.getAttribute('data-player-id');
            console.log('Processing player ID:', playerId);
            const player = appState.players.find(p => p.id === playerId);
            if (player) {
              playerNames.push(player.name);
              console.log('Added player:', player.name);
            } else {
              console.log('Player not found with ID:', playerId);
            }
          });
          
          // Validate we have enough players selected
          if (playerNames.length < playerCount) {
            alert(`Please select ${playerCount} players or switch to "New Players" tab to enter player names.`);
            console.log('Not enough players selected:', playerNames.length, 'needed:', playerCount);
            return;
          }
          
          // Trim to exact count if more selected
          if (playerNames.length > playerCount) {
            playerNames.splice(playerCount);
            console.log('Trimmed players to:', playerNames.length);
          }
        } else {
          // Get player names from inputs
          for (let i = 1; i <= playerCount; i++) {
            const playerName = document.getElementById(`player${i}`).value.trim();
            playerNames.push(playerName || `Player ${i}`);
          }
          console.log('New player names:', playerNames);
        }
        
        console.log('Final player names:', playerNames);
        
        try {
          // Initialize the tournament with the selected tournament type
          initTournament(tournamentName, playerNames, playerCount, courtCount, appState.tournamentType);
          
          // Prevent double submission by disabling the start tournament button
          document.getElementById('startTournamentBtn').disabled = true;
        } catch (error) {
          console.error('Error initializing tournament:', error);
          alert('There was an error creating the tournament. Please try again.');
          document.getElementById('startTournamentBtn').disabled = false;
        }
      });
      
      // Navigation Tabs with animation
      document.getElementById('roundsTab').addEventListener('click', function(e) {
        e.preventDefault();
        if (appState.currentTournament) {
          // Add subtle animation feedback
          this.style.transform = 'scale(0.95)';
          setTimeout(() => {
            this.style.transform = 'none';
            showScreen('roundsScreen');
          }, 100);
        }
      });
      
      // Rounds back button
      document.getElementById('roundsBackBtn').addEventListener('click', function() {
        showScreen('tournamentListScreen');
      });
      
      document.getElementById('leaderboardTab').addEventListener('click', function(e) {
        e.preventDefault();
        if (appState.currentTournament) {
          // Add subtle animation feedback
          this.style.transform = 'scale(0.95)';
          setTimeout(() => {
            this.style.transform = 'none';
            showScreen('leaderboardScreen');
          }, 100);
        }
      });
      
      // Leaderboard back button
      document.getElementById('leaderboardBackBtn').addEventListener('click', function() {
        showScreen('roundsScreen');
      });

      // Export buttons
      document.getElementById('exportPDF').addEventListener('click', exportToPDF);
      document.getElementById('exportPNG').addEventListener('click', exportToPNG);
      document.getElementById('shareLeaderboard').addEventListener('click', shareTournamentLeaderboard);
      
      // Check for shared tournament in URL
      const urlParams = new URLSearchParams(window.location.search);
      const sharedData = urlParams.get('share');
      if (sharedData) {
        try {
          // Decode and parse the shared tournament data
          const tournament = JSON.parse(atob(sharedData));
          
          // Load shared tournament directly if it's not in our local storage
          if (!appState.tournaments[tournament.id]) {
            // Make a copy to avoid reference issues
            const importedTournament = JSON.parse(JSON.stringify(tournament));
            
            // Ensure all required player properties exist (fixing potentially stripped data from sharing)
            importedTournament.players = importedTournament.players.map(player => ({
              id: player.id,
              name: player.name,
              score: player.score || 0,
              matchesPlayed: player.matchesPlayed || 0,
              matchesWon: player.matchesWon || 0,
              matchesLost: player.matchesLost || 0,
              matchesTied: player.matchesTied || 0,
              pointsFor: player.pointsFor || 0,
              pointsAgainst: player.pointsAgainst || 0,
              restsCount: player.restsCount || 0
            }));
            
            // Calculate player stats based on the shared data
            if (importedTournament.players && importedTournament.rounds) {
              importedTournament.players = calculatePlayerStats(
                [...importedTournament.players], 
                importedTournament.rounds
              );
            }
            
            // Save to local state and storage
            appState.tournaments[importedTournament.id] = importedTournament;
            localStorage.setItem('padelAmericanoTournaments', JSON.stringify(appState.tournaments));
            
            // Also save to Firebase if available
            if (window.firebaseDB && window.isFirebaseOnline && navigator.onLine) {
              const tournamentRef = window.firebaseRef(window.firebaseDB, `tournaments/${importedTournament.id}`);
              window.firebaseSet(tournamentRef, importedTournament)
                .then(() => {
                  console.log('Shared tournament saved to Firebase');
                })
                .catch(error => {
                  console.error('Error saving shared tournament to Firebase:', error);
                });
            }
            
            // Set as current tournament
            appState.currentTournament = importedTournament;
            
            // Show notification
            alert(`Shared tournament "${importedTournament.name}" has been loaded.`);
            
            // Navigate to leaderboard
            showScreen('leaderboardScreen');
            renderLeaderboard();
          } else {
            // If we already have this tournament, just load it
            loadTournament(tournament.id);
          }
        } catch (error) {
          console.error('Invalid share data:', error);
          alert('Could not load the shared tournament. Invalid data format.');
        }
      }
      
      // Load tournaments and players on app start
      loadTournaments();
      loadPlayersData();
      
      // Load tournaments and players on app start - no test data needed for production
    });
  </script>
  </div> <!-- Close page-container -->

  <script>
    // Mobile App-like Navigation with Consistent Animations
    let currentScreen = 'tournamentListScreen';
    let navigationHistory = [];

    function navigateToScreen(screenId, addToHistory = true) {
      const currentScreenEl = document.getElementById(currentScreen);
      const nextScreenEl = document.getElementById(screenId);
      
      if (!nextScreenEl || currentScreen === screenId) return;

      // Add to navigation history
      if (addToHistory) {
        navigationHistory.push(currentScreen);
      }

      // Apply consistent fade transitions for all screen changes
      // First set up the next screen before animation
      nextScreenEl.style.opacity = '0';
      nextScreenEl.style.transform = 'none';
      nextScreenEl.style.display = 'block';
      nextScreenEl.classList.add('active');
      
      // Fade out current screen
      currentScreenEl.style.transition = 'opacity 0.3s ease';
      currentScreenEl.style.opacity = '0';
      
      // After a short delay, hide current and show next screen
      setTimeout(() => {
        currentScreenEl.classList.remove('active');
        currentScreenEl.style.display = 'none';
        
        // Fade in next screen
        nextScreenEl.style.transition = 'opacity 0.3s ease';
        nextScreenEl.style.opacity = '1';
        
        // Update app state
        currentScreen = screenId;
        updateBackButton();
        updateNavigation(screenId);
        
        // Jump to top
        nextScreenEl.scrollTo(0, 0);
      }, 300);
    }

    function navigateBack() {
      if (navigationHistory.length > 0) {
        const previousScreen = navigationHistory.pop();
        navigateToScreen(previousScreen, false);
      } else {
        // If no history, toggle sidebar menu instead
        toggleSidebar();
      }
    }

    // No longer needed as we're using sidebar menu everywhere
    function updateBackButton() {
      // Keep function for compatibility but do nothing
      // The back button will always be hidden
    }

    // Simplified click functionality (no animations)
    function addTouchFeedback() {
      const interactiveElements = document.querySelectorAll('button, .btn, .tournament-item, .card, .nav-item, .sidebar-menu-item, .leaderboard-item, .round-tab');
      
      interactiveElements.forEach(element => {
        // Remove any existing transforms
        element.style.transform = 'none';
        
        // Add simple active state by adding/removing class
        element.addEventListener('touchstart', function(e) {
          this.classList.add('active-touch');
        }, { passive: true });
        
        element.addEventListener('touchend', function(e) {
          this.classList.remove('active-touch');
        }, { passive: true });
        
        element.addEventListener('touchcancel', function(e) {
          this.classList.remove('active-touch');
        }, { passive: true });
      });
    }

    // Initialize mobile enhancements
    document.addEventListener('DOMContentLoaded', function() {
      addTouchFeedback();
      
      // We don't need to call updateBackButton since we're using sidebar everywhere
      
      // Update existing navigation calls to use new system
      const backBtn = document.getElementById('backBtn');
      if (backBtn) {
        backBtn.addEventListener('click', toggleSidebar);
      }
      
      // Override existing showScreen function
      window.showScreen = navigateToScreen;
      
      // Set up stable scrolling
      document.documentElement.style.scrollBehavior = 'auto';
      
      // Make all scrollable elements use standard scrolling
      const scrollElements = document.querySelectorAll('.screen, .container, .sidebar-content');
      scrollElements.forEach(element => {
        element.style.webkitOverflowScrolling = 'auto';
        element.style.overscrollBehavior = 'none';
      });
    });

    // Add smooth scrolling behavior
    document.documentElement.style.scrollBehavior = 'smooth';
    
    // Prevent zoom on double tap for iOS
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function (event) {
      const now = (new Date()).getTime();
      if (now - lastTouchEnd <= 300) {
        event.preventDefault();
      }
      lastTouchEnd = now;
    }, false);
    
    // Function to share tournament leaderboard
    function shareTournamentLeaderboard() {
      if (!appState.currentTournament) return;
      
      try {
        // Create a minimized sharable object with only essential tournament data
        const tournament = appState.currentTournament;
        
        // Ensure uniqueId exists (for backward compatibility)
        if (!tournament.uniqueId) {
          // Generate a uniqueId if it doesn't exist
          tournament.uniqueId = Date.now().toString(36) + Math.random().toString(36).substring(2, 7);
          // Save it back to the tournament
          saveTournamentData(tournament);
        }
        
        // Create a simplified version of the player data to reduce URL size
        const simplifiedPlayers = tournament.players.map(player => ({
          id: player.id,
          name: player.name,
          score: player.score || 0,
          matchesPlayed: player.matchesPlayed || 0,
          matchesWon: player.matchesWon || 0,
          matchesLost: player.matchesLost || 0,
          matchesTied: player.matchesTied || 0,
          pointsFor: player.pointsFor || 0,
          pointsAgainst: player.pointsAgainst || 0
        }));
        
        // Create a simplified version of the rounds data to reduce URL size
        const simplifiedRounds = tournament.rounds.map(round => {
          // For each round, only include essential match data
          const simplifiedMatches = round.matches.map(match => ({
            id: match.id,
            teamA: match.teamA,
            teamB: match.teamB,
            scoreA: match.scoreA,
            scoreB: match.scoreB,
            completed: match.completed,
            courtNumber: match.courtNumber
          }));
          
          return {
            roundNumber: round.roundNumber,
            matches: simplifiedMatches,
            restingPlayers: round.restingPlayers
          };
        });
        
        // Create minimized shareable data
        const shareableData = {
          uniqueId: tournament.uniqueId,
          id: tournament.id,
          name: tournament.name,
          players: simplifiedPlayers,
          rounds: simplifiedRounds,
          type: tournament.type,
          createdAt: tournament.createdAt
        };
        
        // Convert to base64 encoded string
        const base64Data = btoa(JSON.stringify(shareableData));
        
        // Create shareable URL pointing to the standalone leaderboard page
        // Use a more robust URL construction that works both locally and when deployed
        const currentUrl = window.location.href;
        const currentPath = currentUrl.substring(0, currentUrl.lastIndexOf('/') + 1);
        const shareUrl = `${currentPath}leaderboard.html?share=${base64Data}`;
        
        // Check if the URL is too long (CloudFront has a limit around 8KB)
        if (shareUrl.length > 7000) {
          // For very large tournaments, try sharing just the ID instead
          if (tournament.id) {
            const idShareUrl = `${currentPath}leaderboard.html?id=${tournament.id}`;
            alert('Tournament data is very large. Sharing a direct link instead of full data.');
            shareWithUrl(idShareUrl, tournament.name);
            return;
          } else {
            throw new Error('Tournament data is too large to share directly and has no ID for reference.');
          }
        }
        
        // Share the URL
        shareWithUrl(shareUrl, tournament.name);
      } catch (error) {
        console.error('Error creating share link:', error);
        alert('Could not generate share link: ' + error.message);
      }
    }
    
    // Function to share a URL with proper error handling
    function shareWithUrl(url, tournamentName) {
      // Check if we're in the Youware environment - use fallback method directly
      if (window.location.hostname.includes('youware') || window.location.hostname.includes('localhost')) {
        fallbackShare(url);
        return;
      }
      
      // Use Web Share API if available in other environments
      if (navigator.share) {
        navigator.share({
          title: `${tournamentName} - Tournament Results`,
          text: `Check out the leaderboard for ${tournamentName}`,
          url: url
        })
        .catch(err => {
          console.error('Error sharing:', err);
          // Check for specific permission errors
          if (err.name === 'NotAllowedError') {
            alert('Sharing was denied. Using fallback method instead.');
          }
          fallbackShare(url);
        });
      } else {
        fallbackShare(url);
      }
    }
    
    // Fallback share method (copy to clipboard)
    function fallbackShare(url) {
      // Try the modern Clipboard API first
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(url)
          .then(() => {
            // Success message
            alert('Share link copied to clipboard! You can now paste and send it to others.');
          })
          .catch(err => {
            console.error('Clipboard API failed:', err);
            fallbackClipboardCopy(url);
          });
      } else {
        // Fall back to the older method if Clipboard API is not available
        fallbackClipboardCopy(url);
      }
    }
    
    // Legacy method for clipboard copy as a last resort
    function fallbackClipboardCopy(url) {
      try {
        // Create temporary input
        const input = document.createElement('input');
        input.style.position = 'fixed';
        input.style.opacity = 0;
        input.value = url;
        document.body.appendChild(input);
        
        // Select and copy
        input.focus();
        input.select();
        input.setSelectionRange(0, 99999);
        
        const successful = document.execCommand('copy');
        document.body.removeChild(input);
        
        if (successful) {
          alert('Share link copied to clipboard! You can now paste and send it to others.');
        } else {
          throw new Error('Copy command was unsuccessful');
        }
      } catch (err) {
        console.error('Fallback clipboard copy failed:', err);
        alert('Could not copy to clipboard automatically. The share URL is:\n\n' + url + '\n\nPlease copy it manually.');
      }
    }
  </script>

  <!-- JSZip library for creating ZIP files -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  
  <!-- PWA Service Worker Registration -->
  <script src="/pwa-utils.js"></script>
  <script>
    // Register service worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('/sw.js')
          .then(function(registration) {
            console.log('✅ Service Worker registered successfully:', registration.scope);
            
            // Check for updates
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  console.log('🔄 New version available. Page will refresh...');
                  if (confirm('A new version is available. Refresh to update?')) {
                    window.location.reload();
                  }
                }
              });
            });
          })
          .catch(function(error) {
            console.log('❌ Service Worker registration failed:', error);
          });
      });

      // Listen for messages from service worker
      navigator.serviceWorker.addEventListener('message', event => {
        console.log('📨 Message from SW:', event.data);
        if (event.data.type === 'SYNC_SUCCESS') {
          console.log('✅ Background sync completed');
        }
      });
    }

    // Source Code Download Function
    async function downloadSourceCode() {
      try {
        // Create a new JSZip instance
        const zip = new JSZip();
        
        // Add the files to the ZIP - we'll fetch them all from the server
        const filesToAdd = [
          'index.html',
          'leaderboard.html',
          'offline.html',
          'manifest.json',
          'browserconfig.xml',
          'sw.js',
          'pwa-utils.js',
          'robots.txt',
          'sitemap.xml',
          // Icons
          'icon-48.png',
          'icon-72.png',
          'icon-96.png',
          'icon-128.png',
          'icon-144.png',
          'icon-152.png',
          'icon-180.png',
          'icon-192.png',
          'icon-192-maskable.png',
          'icon-512.png',
          'icon-512-maskable.png',
          // Screenshots and other assets
          'screenshot-desktop.png',
          'screenshot-mobile.png',
          'shortcut-leaderboard.png',
          'shortcut-new.png',
          'shortcut-players.png',
          'widget-screenshot.png'
        ];
        
        // Fetch all files and add them to the zip
        const fetchPromises = filesToAdd.map(async (filename) => {
          try {
            const response = await fetch(filename);
            if (!response.ok) throw new Error(`Failed to fetch ${filename}`);
            
            const content = await response.blob();
            zip.file(filename, content);
            console.log(`✅ Added ${filename} to ZIP`);
          } catch (error) {
            console.error(`❌ Error adding ${filename} to ZIP:`, error);
          }
        });
        
        // Wait for all files to be fetched and added
        await Promise.all(fetchPromises);
        
        // Generate the ZIP file
        const zipBlob = await zip.generateAsync({
          type: "blob",
          compression: "DEFLATE",
          compressionOptions: { level: 9 }
        });
        
        // Create a download link and trigger the download
        const downloadLink = document.createElement('a');
        downloadLink.href = URL.createObjectURL(zipBlob);
        downloadLink.download = 'padel-tournament-manager.zip';
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
        
        console.log('✅ ZIP file generated and download started');
      } catch (error) {
        console.error('❌ Error generating ZIP file:', error);
        alert('Error generating ZIP file. Please try again.');
      }
    }

    // Initialize PWA features
    document.addEventListener('DOMContentLoaded', function() {
      // Check if running as PWA
      if (window.matchMedia('(display-mode: standalone)').matches) {
        console.log('✅ Running as PWA');
        document.body.classList.add('pwa-mode');
      }

      // Add install prompt handling
      let deferredPrompt;
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        console.log('💾 Install prompt available');
      });

      // Handle app installed
      window.addEventListener('appinstalled', () => {
        console.log('✅ PWA was installed');
        deferredPrompt = null;
      });
    });
  </script>

  <!-- Firebase App (the core Firebase SDK) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script>
  <!-- Firebase Realtime Database -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js"></script>

</body>
</html>
